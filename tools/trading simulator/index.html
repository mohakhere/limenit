<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Trading Simulator - Learn by Replaying Market History</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .start-screen {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            max-width: 800px;
            margin: 100px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .start-screen h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .setup-form {
            display: grid;
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group select,
        .form-group input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .challenge-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .challenge-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .challenge-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .challenge-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .challenge-card h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }

        .challenge-card p {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .simulator-screen {
            display: none;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .simulator-screen.active {
            display: block;
        }

        .sim-header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sim-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }

        .date-display {
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-control {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .btn-play {
            background: #10b981;
            color: white;
        }

        .btn-pause {
            background: #f59e0b;
            color: white;
        }

        .btn-step {
            background: #6366f1;
            color: white;
        }

        .btn-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .speed-control {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 8px;
        }

        .speed-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .speed-btn.active {
            background: #667eea;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-container {
            position: relative;
            height: 450px;
        }

        .portfolio-sidebar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .portfolio-section {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .portfolio-section:last-child {
            border-bottom: none;
        }

        .portfolio-section h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #333;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #333;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .positions-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .position-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .position-details {
            font-size: 0.85em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .trading-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .trading-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .order-form {
            display: grid;
            gap: 15px;
        }

        .order-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .order-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-buy {
            background: #10b981;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-sell {
            background: #ef4444;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-buy:hover, .btn-sell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .event-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .event-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .event-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .event-btn {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .event-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
        }

        .share-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-share {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-copy {
            background: #6366f1;
            color: white;
        }

        .btn-export {
            background: #10b981;
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .trades-table th {
            background: #f9fafb;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            color: #666;
        }

        .trades-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .quest-banner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quest-info {
            font-weight: 600;
        }

        .quest-progress {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <h1>üìà Historical Trading Simulator</h1>
            <p>Learn trading by replaying real market history. Make decisions, manage risk, and see how you would have performed.</p>
            
            <div class="setup-form">
                <div class="form-group">
                    <label>Starting Capital</label>
                    <input type="number" id="startingCapital" value="100000" min="1000" step="1000">
                </div>

                <div class="form-group">
                    <label>Currency</label>
                    <select id="currency">
                        <option value="USD">USD ($)</option>
                        <option value="INR">INR (‚Çπ)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Market Universe</label>
                    <select id="universe">
                        <option value="us_large">US Large Cap (Tech & Finance)</option>
                        <option value="global_mixed">Global Mixed (Stocks + ETFs)</option>
                        <option value="commodities">Commodities Focus</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Challenge or Free Play</label>
                    <div class="challenge-cards">
                        <div class="challenge-card" data-challenge="free">
                            <h3>üéØ Free Play</h3>
                            <p>2015-2025 Full period</p>
                        </div>
                        <div class="challenge-card" data-challenge="covid">
                            <h3>ü¶† COVID Crash</h3>
                            <p>Survive 2020</p>
                        </div>
                        <div class="challenge-card" data-challenge="growth">
                            <h3>üöÄ Bull Run</h3>
                            <p>2017-2019</p>
                        </div>
                        <div class="challenge-card" data-challenge="volatile">
                            <h3>‚ö° High Volatility</h3>
                            <p>2021-2023</p>
                        </div>
                    </div>
                </div>

                <button class="btn-primary" onclick="startSimulation()">Start Simulation</button>
            </div>
        </div>

        <!-- Simulator Screen -->
        <div class="simulator-screen" id="simulatorScreen">
            <div class="sim-header">
                <div class="sim-title">Trading Simulator</div>
                <div class="date-display" id="dateDisplay">2015-01-01</div>
                <div class="controls">
                    <button class="btn-control btn-play" onclick="togglePlay()" id="playBtn">‚ñ∂ Play</button>
                    <button class="btn-control btn-step" onclick="stepForward()">‚Üí Step</button>
                    <button class="btn-control btn-step" onclick="stepBackward()">‚Üê Back</button>
                    <div class="speed-control">
                        <button class="speed-btn active" data-speed="1" onclick="setSpeed(1)">1x</button>
                        <button class="speed-btn" data-speed="5" onclick="setSpeed(5)">5x</button>
                        <button class="speed-btn" data-speed="30" onclick="setSpeed(30)">30x</button>
                    </div>
                    <button class="btn-control" onclick="showSummary()">üìä Summary</button>
                    <button class="btn-control" onclick="resetSimulation()">üîÑ Reset</button>
                </div>
            </div>

            <div id="questBanner" class="quest-banner" style="display: none;">
                <div>
                    <div class="quest-info" id="questTitle">Quest Active</div>
                    <div class="quest-progress" id="questProgress">Progress: 0%</div>
                </div>
                <button class="btn-control" onclick="closeQuest()">‚úï</button>
            </div>

            <div class="main-grid">
                <div class="chart-section">
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <div class="portfolio-sidebar">
                    <div class="portfolio-section">
                        <h3>üí∞ Account Balance</h3>
                        <div class="stat-row">
                            <span class="stat-label">Cash</span>
                            <span class="stat-value" id="cashValue">$100,000</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Portfolio Value</span>
                            <span class="stat-value" id="portfolioValue">$100,000</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Equity</span>
                            <span class="stat-value" id="totalEquity">$100,000</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">P&L</span>
                            <span class="stat-value" id="totalPnL">$0 (0%)</span>
                        </div>
                    </div>

                    <div class="portfolio-section">
                        <h3>üìä Performance</h3>
                        <div class="stat-row">
                            <span class="stat-label">CAGR</span>
                            <span class="stat-value" id="cagrValue">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Max Drawdown</span>
                            <span class="stat-value" id="drawdownValue">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Sharpe Ratio</span>
                            <span class="stat-value" id="sharpeValue">0.00</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Win Rate</span>
                            <span class="stat-value" id="winRateValue">0%</span>
                        </div>
                    </div>

                    <div class="portfolio-section">
                        <h3>üì¶ Positions (<span id="positionCount">0</span>)</h3>
                        <div class="positions-list" id="positionsList">
                            <p style="color: #999; font-size: 0.9em; text-align: center;">No positions</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="trading-panel">
                <div class="trading-tabs">
                    <button class="tab-btn active" onclick="switchTab('market')">Market Order</button>
                    <button class="tab-btn" onclick="switchTab('limit')">Limit Order</button>
                    <button class="tab-btn" onclick="switchTab('stop')">Stop Loss</button>
                    <button class="tab-btn" onclick="switchTab('dca')">DCA Schedule</button>
                </div>

                <div class="tab-content active" id="marketTab">
                    <div class="order-form">
                        <div class="order-row">
                            <div class="form-group">
                                <label>Symbol</label>
                                <select id="marketSymbol"></select>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" id="marketQuantity" value="10" min="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>% of Cash</label>
                            <input type="range" id="cashPercent" min="0" max="100" value="10" oninput="updateQuantityFromPercent()">
                            <span id="cashPercentValue">10%</span>
                        </div>
                        <div class="order-actions">
                            <button class="btn-buy" onclick="executeMarketOrder('buy')">Buy</button>
                            <button class="btn-sell" onclick="executeMarketOrder('sell')">Sell</button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="limitTab">
                    <div class="order-form">
                        <div class="order-row">
                            <div class="form-group">
                                <label>Symbol</label>
                                <select id="limitSymbol"></select>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" id="limitQuantity" value="10" min="1">
                            </div>
                        </div>
                        <div class="order-row">
                            <div class="form-group">
                                <label>Limit Price</label>
                                <input type="number" id="limitPrice" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Order Type</label>
                                <select id="limitType">
                                    <option value="buy">Buy Limit</option>
                                    <option value="sell">Sell Limit</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="placeLimitOrder()" style="width: 100%;">Place Limit Order</button>
                    </div>
                </div>

                <div class="tab-content" id="stopTab">
                    <div class="order-form">
                        <div class="order-row">
                            <div class="form-group">
                                <label>Position</label>
                                <select id="stopPosition"></select>
                            </div>
                            <div class="form-group">
                                <label>Stop Type</label>
                                <select id="stopType">
                                    <option value="stop_loss">Stop Loss</option>
                                    <option value="take_profit">Take Profit</option>
                                    <option value="trailing">Trailing Stop</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Trigger Price / %</label>
                            <input type="number" id="stopPrice" step="0.01">
                        </div>
                        <button class="btn-primary" onclick="placeStopOrder()" style="width: 100%;">Set Stop Order</button>
                    </div>
                </div>

                <div class="tab-content" id="dcaTab">
                    <div class="order-form">
                        <div class="order-row">
                            <div class="form-group">
                                <label>Symbol</label>
                                <select id="dcaSymbol"></select>
                            </div>
                            <div class="form-group">
                                <label>Amount per Period</label>
                                <input type="number" id="dcaAmount" value="1000" min="100">
                            </div>
                        </div>
                        <div class="order-row">
                            <div class="form-group">
                                <label>Frequency</label>
                                <select id="dcaFrequency">
                                    <option value="7">Weekly</option>
                                    <option value="14">Bi-weekly</option>
                                    <option value="30">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Duration (periods)</label>
                                <input type="number" id="dcaDuration" value="12" min="1">
                            </div>
                        </div>
                        <button class="btn-primary" onclick="scheduleDCA()" style="width: 100%;">Schedule DCA</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="eventTitle">Market Event</h2>
                <button class="modal-close" onclick="closeEventModal()">√ó</button>
            </div>
            <div class="event-badge" id="eventTag">BREAKING</div>
            <div class="event-description" id="eventDescription"></div>
            <h3>How do you react?</h3>
            <div class="event-actions">
                <button class="event-btn" onclick="eventReaction('hold')">ü§ù HOLD</button>
                <button class="event-btn" onclick="eventReaction('sell_25')">üìâ SELL 25%</button>
                <button class="event-btn" onclick="eventReaction('sell_50')">üìâ SELL 50%</button>
                <button class="event-btn" onclick="eventReaction('buy_more')">üìà BUY MORE</button>
                <button class="event-btn" onclick="eventReaction('dca')">üí∞ Start DCA</button>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal" id="summaryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Performance Summary</h2>
                <button class="modal-close" onclick="closeSummaryModal()">√ó</button>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Final Equity</div>
                    <div class="metric-value" id="finalEquity">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Return</div>
                    <div class="metric-value" id="totalReturn">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">CAGR</div>
                    <div class="metric-value" id="summaryCAGR">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Drawdown</div>
                    <div class="metric-value" id="summaryDrawdown">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sharpe Ratio</div>
                    <div class="metric-value" id="summarySharpe">0.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value" id="summaryWinRate">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value" id="summaryTrades">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Skill Score</div>
                    <div class="metric-value" id="skillScore">0</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>Trade History</h3>
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody"></tbody>
                </table>
            </div>

            <div class="share-section">
                <h3>Share Your Results</h3>
                <div class="share-buttons">
                    <button class="btn-share btn-copy" onclick="copyShareLink()">üìã Copy Link</button>
                    <button class="btn-share btn-export" onclick="exportCSV()">üìä Export CSV</button>
                    <button class="btn-share btn-export" onclick="exportPDF()">üìÑ Export PDF</button>
                </div>
                <p style="font-size: 0.85em; color: #666; margin-top: 10px;">Share your performance and challenge friends!</p>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // ========== DATA LAYER ==========
        const HISTORICAL_DATA = {
            // Simulated historical prices (2015-2025)
            instruments: [
                { symbol: 'AAPL', name: 'Apple Inc.', sector: 'Technology' },
                { symbol: 'MSFT', name: 'Microsoft Corp.', sector: 'Technology' },
                { symbol: 'GOOGL', name: 'Alphabet Inc.', sector: 'Technology' },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', sector: 'Consumer' },
                { symbol: 'TSLA', name: 'Tesla Inc.', sector: 'Automotive' },
                { symbol: 'NVDA', name: 'NVIDIA Corp.', sector: 'Technology' },
                { symbol: 'JPM', name: 'JPMorgan Chase', sector: 'Finance' },
                { symbol: 'V', name: 'Visa Inc.', sector: 'Finance' },
                { symbol: 'SPY', name: 'S&P 500 ETF', sector: 'ETF' },
                { symbol: 'QQQ', name: 'Nasdaq 100 ETF', sector: 'ETF' },
            ],
            events: [
                { date: '2016-06-24', title: 'Brexit Vote', tag: 'Political', description: 'UK votes to leave EU, causing global market volatility and uncertainty.' },
                { date: '2016-11-09', title: 'US Election', tag: 'Political', description: 'Donald Trump wins presidential election, markets initially volatile then rally.' },
                { date: '2018-02-05', title: 'Volatility Spike', tag: 'Market', description: 'VIX spikes to highest level since 2015, triggering sharp selloff.' },
                { date: '2018-12-24', title: 'Christmas Eve Crash', tag: 'Market', description: 'S&P 500 falls to lowest level since 2017 amid Fed concerns.' },
                { date: '2020-03-11', title: 'WHO Declares Pandemic', tag: 'Health', description: 'COVID-19 declared pandemic, triggering fastest bear market in history.' },
                { date: '2020-03-23', title: 'Market Bottom', tag: 'Market', description: 'Markets hit bottom after 34% decline, beginning historic recovery.' },
                { date: '2021-01-28', title: 'GameStop Frenzy', tag: 'Market', description: 'Retail traders drive massive short squeeze in GME and other meme stocks.' },
                { date: '2021-11-10', title: 'Inflation Surge', tag: 'Economic', description: 'US inflation hits 6.2%, highest in 30 years, Fed pivot concerns.' },
                { date: '2022-02-24', title: 'Russia Invades Ukraine', tag: 'Geopolitical', description: 'Russia launches invasion, sending energy prices soaring and markets tumbling.' },
                { date: '2022-06-16', title: 'Fed Hikes 75bps', tag: 'Monetary', description: 'Federal Reserve raises rates by 75 basis points, largest hike since 1994.' },
                { date: '2023-03-10', title: 'Silicon Valley Bank Collapse', tag: 'Finance', description: 'SVB fails in second-largest bank failure in US history, contagion fears.' },
                { date: '2023-11-30', title: 'AI Rally Begins', tag: 'Technology', description: 'ChatGPT sparks AI investment boom, tech stocks surge to new highs.' },
            ]
        };

        // Generate price data
        function generatePriceData(symbol, startDate, endDate) {
            const prices = [];
            let currentDate = new Date(startDate);
            const end = new Date(endDate);
            
            // Base prices for different symbols
            const basePrices = {
                'AAPL': 25, 'MSFT': 40, 'GOOGL': 520, 'AMZN': 300,
                'TSLA': 15, 'NVDA': 20, 'JPM': 55, 'V': 60,
                'SPY': 200, 'QQQ': 100
            };
            
            let price = basePrices[symbol] || 100;
            
            // Growth rates (annual)
            const growthRates = {
                'AAPL': 0.25, 'MSFT': 0.28, 'GOOGL': 0.15, 'AMZN': 0.20,
                'TSLA': 0.50, 'NVDA': 0.60, 'JPM': 0.12, 'V': 0.18,
                'SPY': 0.10, 'QQQ': 0.15
            };
            
            const growthRate = growthRates[symbol] || 0.10;
            const volatility = symbol === 'TSLA' ? 0.04 : symbol === 'NVDA' ? 0.035 : 0.02;
            
            while (currentDate <= end) {
                // Add daily randomness
                const dailyReturn = (Math.random() - 0.5) * volatility + growthRate / 252;
                price *= (1 + dailyReturn);
                
                // Apply events
                const dateStr = currentDate.toISOString().split('T')[0];
                const event = HISTORICAL_DATA.events.find(e => e.date === dateStr);
                if (event) {
                    // Event impact
                    if (event.tag === 'Market' || event.tag === 'Health') {
                        price *= (0.85 + Math.random() * 0.1); // 10-15% drop
                    } else if (event.tag === 'Technology' && symbol !== 'JPM') {
                        price *= (1.05 + Math.random() * 0.05); // 5-10% gain
                    }
                }
                
                prices.push({
                    date: dateStr,
                    open: price * (0.995 + Math.random() * 0.01),
                    high: price * (1 + Math.random() * 0.015),
                    low: price * (1 - Math.random() * 0.015),
                    close: price,
                    volume: Math.floor(10000000 + Math.random() * 50000000)
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return prices;
        }

        // ========== STATE MANAGEMENT ==========
        let state = {
            config: {
                startingCapital: 100000,
                currency: 'USD',
                universe: 'us_large',
                challenge: 'free',
                commission: 5,
                slippage: 0.001
            },
            simulation: {
                currentIndex: 0,
                isPlaying: false,
                speed: 1,
                startDate: '2015-01-01',
                endDate: '2025-12-31'
            },
            portfolio: {
                cash: 100000,
                positions: {},
                history: [],
                trades: [],
                equityCurve: []
            },
            orders: {
                limit: [],
                stop: [],
                dca: []
            },
            priceData: {},
            chart: null,
            playInterval: null
        };

        // ========== INITIALIZATION ==========
        function initializeSimulation() {
            // Load price data for all symbols
            HISTORICAL_DATA.instruments.forEach(inst => {
                state.priceData[inst.symbol] = generatePriceData(
                    inst.symbol,
                    state.simulation.startDate,
                    state.simulation.endDate
                );
            });

            // Populate dropdowns
            const selects = ['marketSymbol', 'limitSymbol', 'dcaSymbol'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = HISTORICAL_DATA.instruments
                    .map(inst => `<option value="${inst.symbol}">${inst.symbol} - ${inst.name}</option>`)
                    .join('');
            });

            // Initialize chart
            initializeChart();
            
            // Set initial date
            updateDateDisplay();
            updatePortfolioDisplay();
        }

        function initializeChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        }
                    }
                }
            });

            updateChart();
        }

        // ========== UI INTERACTIONS ==========
        document.querySelectorAll('.challenge-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.challenge-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                state.config.challenge = this.dataset.challenge;
                
                // Set date ranges
                const ranges = {
                    free: ['2015-01-01', '2025-12-31'],
                    covid: ['2019-01-01', '2021-12-31'],
                    growth: ['2017-01-01', '2019-12-31'],
                    volatile: ['2021-01-01', '2023-12-31']
                };
                
                [state.simulation.startDate, state.simulation.endDate] = ranges[this.dataset.challenge];
            });
        });

        function startSimulation() {
            state.config.startingCapital = parseFloat(document.getElementById('startingCapital').value);
            state.config.currency = document.getElementById('currency').value;
            state.config.universe = document.getElementById('universe').value;
            
            state.portfolio.cash = state.config.startingCapital;
            state.portfolio.equityCurve.push({
                date: state.simulation.startDate,
                value: state.config.startingCapital
            });
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('simulatorScreen').classList.add('active');
            
            initializeSimulation();
        }

        function togglePlay() {
            state.simulation.isPlaying = !state.simulation.isPlaying;
            const btn = document.getElementById('playBtn');
            
            if (state.simulation.isPlaying) {
                btn.innerHTML = '‚è∏ Pause';
                btn.classList.remove('btn-play');
                btn.classList.add('btn-pause');
                play();
            } else {
                btn.innerHTML = '‚ñ∂ Play';
                btn.classList.remove('btn-pause');
                btn.classList.add('btn-play');
                if (state.playInterval) {
                    clearInterval(state.playInterval);
                }
            }
        }

        function play() {
            const interval = 1000 / state.simulation.speed;
            state.playInterval = setInterval(() => {
                if (!state.simulation.isPlaying) {
                    clearInterval(state.playInterval);
                    return;
                }
                stepForward();
            }, interval);
        }

        function stepForward() {
            const firstSymbol = HISTORICAL_DATA.instruments[0].symbol;
            const maxIndex = state.priceData[firstSymbol].length - 1;
            
            if (state.simulation.currentIndex >= maxIndex) {
                if (state.simulation.isPlaying) togglePlay();
                showNotification('Simulation complete!');
                return;
            }
            
            state.simulation.currentIndex++;
            processDay();
        }

        function stepBackward() {
            if (state.simulation.currentIndex > 0) {
                state.simulation.currentIndex--;
                processDay();
            }
        }

        function setSpeed(speed) {
            state.simulation.speed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.speed) === speed);
            });
            
            if (state.simulation.isPlaying) {
                clearInterval(state.playInterval);
                play();
            }
        }

        function processDay() {
            const currentDate = getCurrentDate();
            
            // Check for events
            const event = HISTORICAL_DATA.events.find(e => e.date === currentDate);
            if (event && !state.portfolio.processedEvents?.includes(currentDate)) {
                showEventModal(event);
                if (!state.portfolio.processedEvents) state.portfolio.processedEvents = [];
                state.portfolio.processedEvents.push(currentDate);
            }
            
            // Process pending orders
            processLimitOrders();
            processStopOrders();
            processDCAOrders();
            
            // Update displays
            updateDateDisplay();
            updatePortfolioDisplay();
            updateChart();
            updatePositionsList();
            
            // Record equity
            const totalEquity = calculateTotalEquity();
            state.portfolio.equityCurve.push({
                date: currentDate,
                value: totalEquity
            });
        }

        function getCurrentDate() {
            const firstSymbol = HISTORICAL_DATA.instruments[0].symbol;
            return state.priceData[firstSymbol][state.simulation.currentIndex].date;
        }

        function getCurrentPrice(symbol) {
            return state.priceData[symbol][state.simulation.currentIndex].close;
        }

        function updateDateDisplay() {
            document.getElementById('dateDisplay').textContent = getCurrentDate();
        }

        // ========== TRADING FUNCTIONS ==========
        function executeMarketOrder(type) {
            const symbol = document.getElementById('marketSymbol').value;
            const quantity = parseInt(document.getElementById('marketQuantity').value);
            
            if (!quantity || quantity <= 0) {
                showNotification('Invalid quantity');
                return;
            }
            
            const price = getCurrentPrice(symbol);
            const cost = price * quantity;
            const commission = state.config.commission;
            const slippage = price * state.config.slippage;
            
            if (type === 'buy') {
                const totalCost = cost + commission + (slippage * quantity);
                if (totalCost > state.portfolio.cash) {
                    showNotification('Insufficient cash');
                    return;
                }
                
                state.portfolio.cash -= totalCost;
                
                if (!state.portfolio.positions[symbol]) {
                    state.portfolio.positions[symbol] = { quantity: 0, avgPrice: 0 };
                }
                
                const pos = state.portfolio.positions[symbol];
                pos.avgPrice = ((pos.avgPrice * pos.quantity) + (price * quantity)) / (pos.quantity + quantity);
                pos.quantity += quantity;
                
                state.portfolio.trades.push({
                    date: getCurrentDate(),
                    symbol,
                    type: 'buy',
                    quantity,
                    price,
                    commission,
                    total: totalCost
                });
                
                showNotification(`Bought ${quantity} ${symbol} @ ${formatCurrency(price)}`);
            } else {
                if (!state.portfolio.positions[symbol] || state.portfolio.positions[symbol].quantity < quantity) {
                    showNotification('Insufficient shares');
                    return;
                }
                
                const proceeds = cost - commission - (slippage * quantity);
                state.portfolio.cash += proceeds;
                
                const pos = state.portfolio.positions[symbol];
                const pnl = (price - pos.avgPrice) * quantity;
                
                pos.quantity -= quantity;
                if (pos.quantity === 0) {
                    delete state.portfolio.positions[symbol];
                }
                
                state.portfolio.trades.push({
                    date: getCurrentDate(),
                    symbol,
                    type: 'sell',
                    quantity,
                    price,
                    commission,
                    total: proceeds,
                    pnl
                });
                
                showNotification(`Sold ${quantity} ${symbol} @ ${formatCurrency(price)} (P&L: ${formatCurrency(pnl)})`);
            }
            
            updatePortfolioDisplay();
            updatePositionsList();
        }

        function placeLimitOrder() {
            const symbol = document.getElementById('limitSymbol').value;
            const quantity = parseInt(document.getElementById('limitQuantity').value);
            const limitPrice = parseFloat(document.getElementById('limitPrice').value);
            const type = document.getElementById('limitType').value;
            
            state.orders.limit.push({
                symbol,
                quantity,
                limitPrice,
                type,
                placedDate: getCurrentDate()
            });
            
            showNotification(`Limit order placed: ${type} ${quantity} ${symbol} @ ${formatCurrency(limitPrice)}`);
        }

        function processLimitOrders() {
            state.orders.limit = state.orders.limit.filter(order => {
                const currentPrice = getCurrentPrice(order.symbol);
                
                if ((order.type === 'buy' && currentPrice <= order.limitPrice) ||
                    (order.type === 'sell' && currentPrice >= order.limitPrice)) {
                    
                    // Execute as market order
                    if (order.type === 'buy') {
                        const totalCost = (order.limitPrice * order.quantity) + state.config.commission;
                        if (totalCost <= state.portfolio.cash) {
                            state.portfolio.cash -= totalCost;
                            
                            if (!state.portfolio.positions[order.symbol]) {
                                state.portfolio.positions[order.symbol] = { quantity: 0, avgPrice: 0 };
                            }
                            
                            const pos = state.portfolio.positions[order.symbol];
                            pos.avgPrice = ((pos.avgPrice * pos.quantity) + (order.limitPrice * order.quantity)) / (pos.quantity + order.quantity);
                            pos.quantity += order.quantity;
                            
                            showNotification(`Limit order filled: Bought ${order.quantity} ${order.symbol}`);
                            return false;
                        }
                    } else {
                        if (state.portfolio.positions[order.symbol]?.quantity >= order.quantity) {
                            const proceeds = (order.limitPrice * order.quantity) - state.config.commission;
                            state.portfolio.cash += proceeds;
                            
                            const pos = state.portfolio.positions[order.symbol];
                            pos.quantity -= order.quantity;
                            if (pos.quantity === 0) delete state.portfolio.positions[order.symbol];
                            
                            showNotification(`Limit order filled: Sold ${order.quantity} ${order.symbol}`);
                            return false;
                        }
                    }
                }
                
                return true;
            });
        }

        function placeStopOrder() {
            const position = document.getElementById('stopPosition').value;
            const type = document.getElementById('stopType').value;
            const price = parseFloat(document.getElementById('stopPrice').value);
            
            if (!position || !price) {
                showNotification('Please select position and enter price');
                return;
            }
            
            state.orders.stop.push({
                symbol: position,
                type,
                triggerPrice: price,
                placedDate: getCurrentDate()
            });
            
            showNotification(`Stop order set: ${type} for ${position}`);
        }

        function processStopOrders() {
            state.orders.stop = state.orders.stop.filter(order => {
                const currentPrice = getCurrentPrice(order.symbol);
                const position = state.portfolio.positions[order.symbol];
                
                if (!position) return false;
                
                let triggered = false;
                if (order.type === 'stop_loss' && currentPrice <= order.triggerPrice) {
                    triggered = true;
                } else if (order.type === 'take_profit' && currentPrice >= order.triggerPrice) {
                    triggered = true;
                } else if (order.type === 'trailing') {
                    // Simplified trailing stop
                    const changePercent = ((currentPrice - position.avgPrice) / position.avgPrice) * 100;
                    if (changePercent < -order.triggerPrice) triggered = true;
                }
                
                if (triggered) {
                    // Sell position
                    const proceeds = (currentPrice * position.quantity) - state.config.commission;
                    state.portfolio.cash += proceeds;
                    delete state.portfolio.positions[order.symbol];
                    
                    showNotification(`Stop triggered: Sold ${position.quantity} ${order.symbol}`);
                    return false;
                }
                
                return true;
            });
        }

        function scheduleDCA() {
            const symbol = document.getElementById('dcaSymbol').value;
            const amount = parseFloat(document.getElementById('dcaAmount').value);
            const frequency = parseInt(document.getElementById('dcaFrequency').value);
            const duration = parseInt(document.getElementById('dcaDuration').value);
            
            state.orders.dca.push({
                symbol,
                amount,
                frequency,
                duration,
                lastExecuted: state.simulation.currentIndex,
                executionsLeft: duration
            });
            
            showNotification(`DCA scheduled: ${formatCurrency(amount)} into ${symbol} every ${frequency} days`);
        }

        function processDCAOrders() {
            state.orders.dca = state.orders.dca.filter(order => {
                const daysSinceLastExecution = state.simulation.currentIndex - order.lastExecuted;
                
                if (daysSinceLastExecution >= order.frequency && order.executionsLeft > 0) {
                    const price = getCurrentPrice(order.symbol);
                    const quantity = Math.floor(order.amount / price);
                    
                    if (quantity > 0 && order.amount <= state.portfolio.cash) {
                        const totalCost = (price * quantity) + state.config.commission;
                        state.portfolio.cash -= totalCost;
                        
                        if (!state.portfolio.positions[order.symbol]) {
                            state.portfolio.positions[order.symbol] = { quantity: 0, avgPrice: 0 };
                        }
                        
                        const pos = state.portfolio.positions[order.symbol];
                        pos.avgPrice = ((pos.avgPrice * pos.quantity) + (price * quantity)) / (pos.quantity + quantity);
                        pos.quantity += quantity;
                        
                        order.lastExecuted = state.simulation.currentIndex;
                        order.executionsLeft--;
                    }
                }
                
                return order.executionsLeft > 0;
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function updateQuantityFromPercent() {
            const percent = document.getElementById('cashPercent').value;
            const symbol = document.getElementById('marketSymbol').value;
            const price = getCurrentPrice(symbol);
            const amount = (state.portfolio.cash * percent) / 100;
            const quantity = Math.floor(amount / price);
            
            document.getElementById('marketQuantity').value = quantity;
            document.getElementById('cashPercentValue').textContent = percent + '%';
        }

        // ========== DISPLAY UPDATES ==========
        function updatePortfolioDisplay() {
            const currencySymbol = getCurrencySymbol();
            const totalEquity = calculateTotalEquity();
            const portfolioValue = calculatePortfolioValue();
            const pnl = totalEquity - state.config.startingCapital;
            const pnlPercent = (pnl / state.config.startingCapital) * 100;
            
            document.getElementById('cashValue').textContent = formatCurrency(state.portfolio.cash);
            document.getElementById('portfolioValue').textContent = formatCurrency(portfolioValue);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = `${formatCurrency(pnl)} (${pnlPercent.toFixed(2)}%)`;
            pnlElement.className = 'stat-value ' + (pnl >= 0 ? 'positive' : 'negative');
            
            // Calculate metrics
            updateMetrics();
        }

        function updateMetrics() {
            const metrics = calculateMetrics();
            
            document.getElementById('cagrValue').textContent = metrics.cagr.toFixed(2) + '%';
            document.getElementById('drawdownValue').textContent = metrics.maxDrawdown.toFixed(2) + '%';
            document.getElementById('sharpeValue').textContent = metrics.sharpe.toFixed(2);
            document.getElementById('winRateValue').textContent = metrics.winRate.toFixed(1) + '%';
        }

        function calculateMetrics() {
            const equity = state.portfolio.equityCurve;
            if (equity.length < 2) return { cagr: 0, maxDrawdown: 0, sharpe: 0, winRate: 0 };
            
            // CAGR
            const startValue = equity[0].value;
            const endValue = equity[equity.length - 1].value;
            const years = equity.length / 252;
            const cagr = (Math.pow(endValue / startValue, 1 / years) - 1) * 100;
            
            // Max Drawdown
            let peak = startValue;
            let maxDrawdown = 0;
            equity.forEach(point => {
                if (point.value > peak) peak = point.value;
                const drawdown = ((peak - point.value) / peak) * 100;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            });
            
            // Sharpe Ratio
            const returns = [];
            for (let i = 1; i < equity.length; i++) {
                returns.push((equity[i].value - equity[i-1].value) / equity[i-1].value);
            }
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const stdDev = Math.sqrt(returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length);
            const sharpe = stdDev > 0 ? (avgReturn / stdDev) * Math.sqrt(252) : 0;
            
            // Win Rate
            const closedTrades = state.portfolio.trades.filter(t => t.pnl !== undefined);
            const wins = closedTrades.filter(t => t.pnl > 0).length;
            const winRate = closedTrades.length > 0 ? (wins / closedTrades.length) * 100 : 0;
            
            return { cagr, maxDrawdown, sharpe, winRate };
        }

        function updatePositionsList() {
            const container = document.getElementById('positionsList');
            const positions = Object.entries(state.portfolio.positions);
            
            if (positions.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.9em; text-align: center;">No positions</p>';
                document.getElementById('positionCount').textContent = '0';
                
                // Update stop position dropdown
                document.getElementById('stopPosition').innerHTML = '<option value="">No positions</option>';
                return;
            }
            
            document.getElementById('positionCount').textContent = positions.length;
            
            container.innerHTML = positions.map(([symbol, pos]) => {
                const currentPrice = getCurrentPrice(symbol);
                const value = currentPrice * pos.quantity;
                const pnl = (currentPrice - pos.avgPrice) * pos.quantity;
                const pnlPercent = ((currentPrice - pos.avgPrice) / pos.avgPrice) * 100;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                
                return `
                    <div class="position-item">
                        <div class="position-header">
                            <span>${symbol}</span>
                            <span class="${pnlClass}">${formatCurrency(pnl)}</span>
                        </div>
                        <div class="position-details">
                            <span>${pos.quantity} shares @ ${formatCurrency(pos.avgPrice)}</span>
                            <span class="${pnlClass}">${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update stop position dropdown
            document.getElementById('stopPosition').innerHTML = positions.map(([symbol]) => 
                `<option value="${symbol}">${symbol}</option>`
            ).join('');
        }

        function updateChart() {
            if (!state.chart) return;
            
            const startIndex = Math.max(0, state.simulation.currentIndex - 60);
            const endIndex = state.simulation.currentIndex;
            
            // Get date labels
            const firstSymbol = HISTORICAL_DATA.instruments[0].symbol;
            const labels = state.priceData[firstSymbol]
                .slice(startIndex, endIndex + 1)
                .map(d => d.date);
            
            // Build datasets for visible instruments
            const datasets = [];
            
            // Add top 5 instruments
            const visibleInstruments = HISTORICAL_DATA.instruments.slice(0, 5);
            visibleInstruments.forEach((inst, idx) => {
                const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#6366f1'];
                datasets.push({
                    label: inst.symbol,
                    data: state.priceData[inst.symbol]
                        .slice(startIndex, endIndex + 1)
                        .map(d => d.close),
                    borderColor: colors[idx],
                    backgroundColor: colors[idx] + '20',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    yAxisID: 'y'
                });
            });
            
            // Add portfolio value line
            const portfolioData = state.portfolio.equityCurve
                .slice(Math.max(0, state.portfolio.equityCurve.length - 60))
                .map(point => point.value);
            
            if (portfolioData.length > 0) {
                datasets.push({
                    label: 'Portfolio Value',
                    data: portfolioData,
                    borderColor: '#8b5cf6',
                    backgroundColor: '#8b5cf620',
                    borderWidth: 3,
                    tension: 0.1,
                    pointRadius: 0,
                    yAxisID: 'y1'
                });
            }
            
            state.chart.data.labels = labels;
            state.chart.data.datasets = datasets;
            
            // Add second y-axis for portfolio value
            state.chart.options.scales.y1 = {
                type: 'linear',
                position: 'right',
                grid: {
                    drawOnChartArea: false
                }
            };
            
            state.chart.update('none');
        }

        function calculateTotalEquity() {
            let portfolioValue = state.portfolio.cash;
            
            Object.entries(state.portfolio.positions).forEach(([symbol, pos]) => {
                const currentPrice = getCurrentPrice(symbol);
                portfolioValue += currentPrice * pos.quantity;
            });
            
            return portfolioValue;
        }

        function calculatePortfolioValue() {
            let value = 0;
            
            Object.entries(state.portfolio.positions).forEach(([symbol, pos]) => {
                const currentPrice = getCurrentPrice(symbol);
                value += currentPrice * pos.quantity;
            });
            
            return value;
        }

        // ========== EVENT HANDLING ==========
        function showEventModal(event) {
            if (state.simulation.isPlaying) togglePlay();
            
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventTag').textContent = event.tag.toUpperCase();
            document.getElementById('eventDescription').textContent = event.description;
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        function eventReaction(action) {
            const positions = Object.entries(state.portfolio.positions);
            
            switch(action) {
                case 'hold':
                    showNotification('Holding all positions');
                    break;
                    
                case 'sell_25':
                    positions.forEach(([symbol, pos]) => {
                        const quantity = Math.floor(pos.quantity * 0.25);
                        if (quantity > 0) sellPosition(symbol, quantity);
                    });
                    showNotification('Sold 25% of all positions');
                    break;
                    
                case 'sell_50':
                    positions.forEach(([symbol, pos]) => {
                        const quantity = Math.floor(pos.quantity * 0.5);
                        if (quantity > 0) sellPosition(symbol, quantity);
                    });
                    showNotification('Sold 50% of all positions');
                    break;
                    
                case 'buy_more':
                    const symbol = positions.length > 0 ? positions[0][0] : 'SPY';
                    const price = getCurrentPrice(symbol);
                    const quantity = Math.floor((state.portfolio.cash * 0.1) / price);
                    if (quantity > 0) buyPosition(symbol, quantity);
                    showNotification(`Bought more ${symbol}`);
                    break;
                    
                case 'dca':
                    showNotification('DCA strategy activated');
                    break;
            }
            
            closeEventModal();
            updatePortfolioDisplay();
            updatePositionsList();
        }

        function sellPosition(symbol, quantity) {
            const price = getCurrentPrice(symbol);
            const proceeds = (price * quantity) - state.config.commission;
            state.portfolio.cash += proceeds;
            
            const pos = state.portfolio.positions[symbol];
            pos.quantity -= quantity;
            if (pos.quantity === 0) delete state.portfolio.positions[symbol];
        }

        function buyPosition(symbol, quantity) {
            const price = getCurrentPrice(symbol);
            const totalCost = (price * quantity) + state.config.commission;
            
            if (totalCost > state.portfolio.cash) return;
            
            state.portfolio.cash -= totalCost;
            
            if (!state.portfolio.positions[symbol]) {
                state.portfolio.positions[symbol] = { quantity: 0, avgPrice: 0 };
            }
            
            const pos = state.portfolio.positions[symbol];
            pos.avgPrice = ((pos.avgPrice * pos.quantity) + (price * quantity)) / (pos.quantity + quantity);
            pos.quantity += quantity;
        }

        // ========== SUMMARY & SHARING ==========
        function showSummary() {
            if (state.simulation.isPlaying) togglePlay();
            
            const totalEquity = calculateTotalEquity();
            const totalReturn = ((totalEquity - state.config.startingCapital) / state.config.startingCapital) * 100;
            const metrics = calculateMetrics();
            
            document.getElementById('finalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('totalReturn').textContent = totalReturn.toFixed(2) + '%';
            document.getElementById('summaryCAGR').textContent = metrics.cagr.toFixed(2) + '%';
            document.getElementById('summaryDrawdown').textContent = metrics.maxDrawdown.toFixed(2) + '%';
            document.getElementById('summarySharpe').textContent = metrics.sharpe.toFixed(2);
            document.getElementById('summaryWinRate').textContent = metrics.winRate.toFixed(1) + '%';
            document.getElementById('summaryTrades').textContent = state.portfolio.trades.length;
            
            // Skill Score: equity * (1 - drawdown penalty)
            const skillScore = Math.round(totalEquity * (1 - metrics.maxDrawdown * 0.005));
            document.getElementById('skillScore').textContent = skillScore.toLocaleString();
            
            // Populate trades table
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = state.portfolio.trades.slice(-20).reverse().map(trade => `
                <tr>
                    <td>${trade.date}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.type.toUpperCase()}</td>
                    <td>${trade.quantity}</td>
                    <td>${formatCurrency(trade.price)}</td>
                    <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">${trade.pnl ? formatCurrency(trade.pnl) : '-'}</td>
                </tr>
            `).join('');
            
            document.getElementById('summaryModal').classList.add('active');
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('active');
        }

        function copyShareLink() {
            const totalEquity = calculateTotalEquity();
            const totalReturn = ((totalEquity - state.config.startingCapital) / state.config.startingCapital) * 100;
            const metrics = calculateMetrics();
            
            const shareText = `I just completed a trading simulation!\n\nüí∞ Return: ${totalReturn.toFixed(2)}%\nüìà CAGR: ${metrics.cagr.toFixed(2)}%\nüìâ Max Drawdown: ${metrics.maxDrawdown.toFixed(2)}%\n‚ö° Sharpe: ${metrics.sharpe.toFixed(2)}\n\nChallenge: ${state.config.challenge}\nTrades: ${state.portfolio.trades.length}`;
            
            navigator.clipboard.writeText(shareText).then(() => {
                showNotification('Results copied to clipboard!');
            });
        }

        function exportCSV() {
            let csv = 'Date,Symbol,Type,Quantity,Price,Commission,Total,P&L\n';
            
            state.portfolio.trades.forEach(trade => {
                csv += `${trade.date},${trade.symbol},${trade.type},${trade.quantity},${trade.price},${trade.commission},${trade.total},${trade.pnl || ''}\n`;
            });
            
            csv += '\n\nEquity Curve\nDate,Value\n';
            state.portfolio.equityCurve.forEach(point => {
                csv += `${point.date},${point.value}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_simulation_${getCurrentDate()}.csv`;
            a.click();
            
            showNotification('CSV exported successfully!');
        }

        function exportPDF() {
            showNotification('PDF export requires email. Enter your email to receive the report.');
            // In a real implementation, this would open an email modal
        }

        function resetSimulation() {
            if (confirm('Are you sure you want to reset? All progress will be lost.')) {
                location.reload();
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatCurrency(amount) {
            const symbols = { USD: '$', INR: '‚Çπ', EUR: '‚Ç¨', GBP: '¬£' };
            const symbol = symbols[state.config.currency] || '';
            return symbol + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getCurrencySymbol() {
            const symbols = { USD: '$', INR: '‚Çπ', EUR: '‚Ç¨', GBP: '¬£' };
            return symbols[state.config.currency] || '';
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function closeQuest() {
            document.getElementById('questBanner').style.display = 'none';
        }

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlay();
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                stepForward();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                stepBackward();
            }
        });

        // Initialize default challenge selection
        document.querySelector('.challenge-card[data-challenge="free"]').classList.add('selected');
    </script>
</body>
</html>
