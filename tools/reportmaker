<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LimeNit - Modern Analytics Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-elevated: #1f1f1f;
            
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #6c6c6c;
            
            --border-primary: #2a2a2a;
            --border-secondary: #333333;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
            
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body.light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f5;
            --bg-elevated: #ffffff;
            
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --text-tertiary: #adb5bd;
            
            --border-primary: #dee2e6;
            --border-secondary: #e9ecef;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        /* Top Toolbar */
        .toolbar {
            height: 56px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            position: relative;
            z-index: 100;
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }
        
        .logo:hover {
            background: var(--bg-secondary);
        }
        
        .logo-accent {
            color: var(--primary);
        }
        
        .workspace-tabs {
            display: flex;
            gap: 0.25rem;
            margin-left: 1rem;
        }
        
        .workspace-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .workspace-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .workspace-tab.active {
            background: var(--bg-secondary);
            color: var(--primary);
        }
        
        .workspace-tab .close {
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .workspace-tab:hover .close {
            opacity: 1;
        }
        
        /* Toolbar Actions */
        .toolbar-btn {
            padding: 0.5rem 0.875rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toolbar-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-secondary);
        }
        
        .toolbar-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .toolbar-btn.primary:hover {
            background: #ff5252;
            border-color: #ff5252;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        /* Main Layout */
        .app-container {
            display: flex;
            height: calc(100vh - 56px);
        }
        
        /* Left Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-elevated);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-base);
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .sidebar-nav {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--bg-secondary);
            color: var(--primary);
        }
        
        .nav-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0.75rem;
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }
        
        .section-header:hover {
            background: var(--bg-secondary);
        }
        
        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        
        .section-toggle {
            transition: transform var(--transition-fast);
        }
        
        .section-header.collapsed .section-toggle {
            transform: rotate(-90deg);
        }
        
        .section-content {
            overflow: hidden;
            transition: max-height var(--transition-base);
        }
        
        .section-content.collapsed {
            max-height: 0 !important;
        }
        
        /* Main Canvas */
        .main-canvas {
            flex: 1;
            background: var(--bg-primary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .canvas-header {
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .canvas-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .canvas-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .canvas-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        /* Right Panel */
        .right-panel {
            width: 320px;
            background: var(--bg-elevated);
            border-left: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-base);
            position: relative;
        }
        
        .right-panel.hidden {
            transform: translateX(100%);
        }
        
        .panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.25rem;
        }
        
        /* Cards & UI Elements */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1rem;
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .card:hover {
            border-color: var(--border-secondary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .quick-action-card {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .quick-action-card:hover {
            border-color: var(--primary);
            background: var(--bg-tertiary);
            transform: scale(1.02);
        }
        
        .quick-action-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            stroke: var(--primary);
        }
        
        /* Chart Library */
        .chart-library-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: grab;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .chart-library-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }
        
        .chart-library-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .chart-preview {
    position: absolute;
    left: 100%;
    top: 0;
    margin-left: 1rem;
    width: 300px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 1rem;
    box-shadow: var(--shadow-xl);
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-fast);
    z-index: 1000;
}
        
        .chart-library-item:hover .chart-preview {
            opacity: 1;
        }
        
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        .drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.05);
        }
        .chart-grid.drop-zone {
    border: 2px dashed var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 3rem;
    transition: all var(--transition-fast);
}

.chart-grid.drop-zone.drag-over {
    border-color: var(--primary);
    background: rgba(255, 107, 107, 0.05);
}
        
        .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
    gap: 1.5rem;
    width: 100%;
}
        
        .chart-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .chart-container:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .chart-container.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .chart-title-input {
            background: transparent;
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            padding: 0.375rem 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            font-family: inherit;
            flex: 1;
            transition: all var(--transition-fast);
        }
        
        .chart-title-input:hover {
            background: var(--bg-secondary);
        }
        
        .chart-title-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-secondary);
        }
        
        .chart-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .chart-container:hover .chart-actions {
            opacity: 1;
        }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        
        .btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-secondary);
        }
        
        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #ff5252;
            border-color: #ff5252;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            border-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #3dbfb6;
        }
        
        .btn-icon {
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-ghost {
            border: none;
            background: transparent;
        }
        
        .btn-ghost:hover {
            background: var(--bg-secondary);
        }
        
        /* Icon Button */
        .icon-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        /* Input */
        .input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            transition: all var(--transition-fast);
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }
        
        .input::placeholder {
            color: var(--text-tertiary);
        }
        
        /* Select */
        .select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Command Palette */
        .command-palette-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20vh;
            z-index: 9999;
            animation: fadeIn 150ms ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .command-palette {
            width: 600px;
            max-width: 90vw;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            animation: slideDown 200ms cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .command-input {
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-primary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }
        
        .command-input:focus {
            outline: none;
        }
        
        .command-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .command-item {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background var(--transition-fast);
        }
        
        .command-item:hover,
        .command-item.selected {
            background: var(--bg-secondary);
        }
        
        .command-item-icon {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }
        
        .command-item-text {
            flex: 1;
        }
        
        .command-item-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .command-item-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .command-item-shortcut {
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        /* Tooltip */
        .tooltip-trigger {
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            color: var(--text-primary);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: 1000;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--border-primary);
        }
        
        .tooltip-trigger:hover .tooltip {
            opacity: 1;
        }
        
        /* Tutorial Overlay */
        .tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tutorial-spotlight {
            position: absolute;
            border: 3px solid var(--primary);
            border-radius: var(--radius-lg);
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 20px var(--primary); }
            50% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 40px var(--primary); }
        }
        
        .tutorial-card {
            position: relative;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            z-index: 10001;
        }
        
        .tutorial-progress {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-primary);
            transition: all var(--transition-fast);
        }
        
        .tutorial-dot.active {
            background: var(--primary);
            width: 24px;
            border-radius: 4px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9000;
            animation: fadeIn 150ms ease;
        }
        
        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 250ms cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.96);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-primary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 800ms linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }    
        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            opacity: 0.3;
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .empty-state-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        /* Resize Handle */
        .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: col-resize;
            background: transparent;
            transition: background var(--transition-fast);
        }
        
        .resize-handle:hover,
        .resize-handle.resizing {
            background: var(--primary);
        }
        
        .resize-handle-left {
            left: -2px;
        }
        
        .resize-handle-right {
            right: -2px;
        }
        
        /* SVG Icons */
        svg {
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* Utility */
        .hidden { display: none !important; }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: rgba(255, 107, 107, 0.15);
            color: var(--primary);
        }
        
        .badge-secondary {
            background: rgba(78, 205, 196, 0.15);
            color: var(--secondary);
        }
        
        .badge-success {
            background: rgba(0, 184, 148, 0.15);
            color: var(--success);
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .data-table th {
            background: var(--bg-secondary);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
        }
        
        .data-table th:hover {
            background: var(--bg-tertiary);
        }
        
        .data-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border-primary);
            font-size: 0.875rem;
            transition: background var(--transition-fast);
        }
        
        .data-table tr:hover td {
            background: var(--bg-secondary);
        }
        
        .data-table td input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            background: var(--bg-primary);
            border: 2px solid var(--primary);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
        }
        
        .data-table td input:focus {
            outline: none;
        }
        
        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-item {
            flex: 1;
            min-width: 180px;
        }
        
        .filter-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Active Filters */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            font-size: 0.75rem;
            color: var(--text-primary);
        }
        
        .filter-chip-close {
            width: 14px;
            height: 14px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color var(--transition-fast);
        }
        
        .filter-chip-close:hover {
            color: var(--danger);
        }
        
        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .template-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .template-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.15);
        }
        
        .template-preview {
            height: 180px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .template-info {
            padding: 1rem;
        }
        
        .template-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .template-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Presentation Mode */
        .presentation-mode {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 10000;
            display: flex;
            flex-direction: column;
        }
        
        .presentation-header {
            height: 60px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }
        
        .presentation-content {
            flex: 1;
            overflow: auto;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .presentation-slide {
            max-width: 1200px;
            width: 100%;
            background: var(--bg-elevated);
            border-radius: var(--radius-xl);
            padding: 3rem;
            box-shadow: var(--shadow-xl);
        }
        
        .presentation-nav {
            display: flex;
            gap: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="loading" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

    <script>
        // State Management
        const state = {
            theme: 'dark',
            currentView: 'workspace',
            currentPage: 'landing',
            dataViewMode: 'charts', // Add this line
            workspaces: [
                { id: 1, name: 'Sales Data', active: true }
            ],
            data: null,
            filteredData: null,
            charts: [],
            selectedChartId: null,
            filters: {
                dateColumn: null,
                dateRange: 'all',
                searchQuery: '',
                numericFilters: {},
                categoricalFilters: {}
            },
            sortColumn: null,
            sortDirection: 'asc',
            showCommandPalette: false,
            showTutorial: !localStorage.getItem('tutorialCompleted'),
            tutorialStep: 0,
            leftSidebarWidth: 260,
            rightPanelVisible: true,
            rightPanelWidth: 320,
            modal: null,
            presentationMode: false,
            savedViews: [],
            chartLibrary: [],
            templates: {
                pdf: [
                    {
                        id: 'modern',
                        name: 'Modern',
                        description: 'Clean and minimal design',
                        preview: '<div style="font-family:Inter;padding:20px;border-bottom:3px solid #ff6b6b"><div style="font-size:24px;font-weight:700;color:#1a1a1a">Report Title</div></div>'
                    },
                    {
                        id: 'corporate',
                        name: 'Corporate',
                        description: 'Professional business template',
                        preview: '<div style="font-family:Inter;padding:20px;background:#1a1a1a;color:white;border-radius:8px"><div style="font-size:22px;font-weight:700">BUSINESS REPORT</div></div>'
                    },
                    {
                        id: 'minimal',
                        name: 'Minimal',
                        description: 'Simple and elegant',
                        preview: '<div style="font-family:Inter;padding:20px;text-align:center"><div style="font-size:20px;font-weight:300">Report</div></div>'
                    },
                    {
                        id: 'colorful',
                        name: 'Colorful',
                        description: 'Vibrant and eye-catching',
                        preview: '<div style="font-family:Inter;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:8px"><div style="font-size:24px;font-weight:700">Creative Report</div></div>'
                    }
                ],
                presentation: [
                    {
                        id: 'slides-modern',
                        name: 'Modern Slides',
                        description: 'Interactive presentation with gradients',
                        preview: '<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;color:white;border-radius:8px"><div style="font-size:20px;font-weight:700">Slide 1</div></div>'
                    },
                    {
                        id: 'slides-minimal',
                        name: 'Minimal Slides',
                        description: 'Clean presentation layout',
                        preview: '<div style="border:2px solid #ddd;padding:20px;border-radius:8px"><div style="font-size:20px;font-weight:600">Slide 1</div></div>'
                    }
                ]
            }
        };

        // Utility Functions
        function showLoading(text = 'Processing...') {
            const loading = document.getElementById('loading');
            loading.querySelector('.loading-text').textContent = text;
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const formats = [
                /^(\d{4})-(\d{2})-(\d{2})/,
                /^(\d{2})\/(\d{2})\/(\d{4})/,
                /^(\d{1,2})-(\d{1,2})-(\d{4})/,
            ];
            
            for (let format of formats) {
                const match = String(dateStr).match(format);
                if (match) {
                    if (format.source.startsWith('^\\(\\\\d\\{4\\}')) {
                        return new Date(match[1], match[2] - 1, match[3]);
                    } else {
                        const date1 = new Date(match[3], match[2] - 1, match[1]);
                        if (!isNaN(date1.getTime())) return date1;
                        const date2 = new Date(match[3], match[1] - 1, match[2]);
                        if (!isNaN(date2.getTime())) return date2;
                    }
                }
            }
            
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        function isDateColumn(col) {
            if (!state.data || state.data.length === 0) return false;
            const samples = state.data.slice(0, 10).map(row => row[col]).filter(v => v);
            if (samples.length === 0) return false;
            const validDates = samples.filter(val => parseDate(val) !== null);
            return validDates.length / samples.length > 0.7;
        }

        function getColumnType(col) {
            const data = state.filteredData || state.data;
            if (!data || data.length === 0) return 'text';
            const sample = data[0][col];
            
            if (sample === null || sample === undefined || sample === '') return 'text';
            const num = parseFloat(sample);
            if (!isNaN(num) && isFinite(num)) return 'number';
            if (isDateColumn(col)) return 'date';
            return 'text';
        }

        // File Upload
        function handleFileUpload(file) {
            if (!file) return;
            
            showLoading('Reading file...');
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        raw: false,
                        dateNF: 'yyyy-mm-dd'
                    });
                    
                    if (jsonData.length === 0) {
                        hideLoading();
                        alert('No data found in file');
                        return;
                    }
                    
                    state.data = jsonData;
                    state.filteredData = jsonData;
                    state.currentPage = 'workspace';
                    
                    const columns = Object.keys(jsonData[0]);
                    const dateCol = columns.find(col => isDateColumn(col));
                    if (dateCol) state.filters.dateColumn = dateCol;
                    
                    initializeChartLibrary();
                    hideLoading();
                    render();
                } catch (error) {
                    hideLoading();
                    alert('Error reading file: ' + error.message);
                }
            };
            
            reader.onerror = () => {
                hideLoading();
                alert('Error reading file');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Chart Library Initialization
        function initializeChartLibrary() {
            const data = state.filteredData || state.data;
            if (!data || data.length === 0) return;
            
            const columns = Object.keys(data[0]);
            const numericCols = columns.filter(col => {
                const values = data.slice(0, 5).map(row => row[col]);
                return values.every(v => !isNaN(parseFloat(v)) && v !== '');
            });
            const categoricalCols = columns.filter(col => !numericCols.includes(col));
            
            state.chartLibrary = [];
            
            if (categoricalCols.length > 0 && numericCols.length > 0) {
                state.chartLibrary.push({
                    id: 'bar-1',
                    type: 'bar',
                    name: 'Bar Chart',
                    description: `${categoricalCols[0]} vs ${numericCols[0]}`,
                    config: { xCol: categoricalCols[0], yCol: numericCols[0] }
                });
            }
            
            if (columns.length >= 2 && numericCols.length > 0) {
                state.chartLibrary.push({
                    id: 'line-1',
                    type: 'line',
                    name: 'Line Chart',
                    description: `${columns[0]} Trend`,
                    config: { xCol: columns[0], yCol: numericCols[0] }
                });
            }
            
            if (categoricalCols.length > 0 && numericCols.length > 0) {
                state.chartLibrary.push({
                    id: 'pie-1',
                    type: 'pie',
                    name: 'Pie Chart',
                    description: `${numericCols[0]} Distribution`,
                    config: { labelCol: categoricalCols[0], dataCol: numericCols[0] }
                });
            }
            
            if (numericCols.length >= 2) {
                state.chartLibrary.push({
                    id: 'scatter-1',
                    type: 'scatter',
                    name: 'Scatter Plot',
                    description: `${numericCols[0]} vs ${numericCols[1]}`,
                    config: { xCol: numericCols[0], yCol: numericCols[1] }
                });
            }
            
            if (categoricalCols.length > 0 && numericCols.length > 0) {
                state.chartLibrary.push({
                    id: 'doughnut-1',
                    type: 'doughnut',
                    name: 'Doughnut Chart',
                    description: `${categoricalCols[0]} Breakdown`,
                    config: { labelCol: categoricalCols[0], dataCol: numericCols[0] }
                });
            }
        }

        // Add Chart to Canvas
function addChartToCanvas(libraryItem) {
            const newChart = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                ...libraryItem,
                title: libraryItem.name || 'Untitled Chart',
                color: libraryItem.color || '#ff6b6b',
                showLegend: libraryItem.showLegend !== undefined ? libraryItem.showLegend : true,
                showLabels: libraryItem.showLabels !== undefined ? libraryItem.showLabels : true,
                config: libraryItem.config ? { ...libraryItem.config } : {}
            };
            state.charts.push(newChart);
            state.selectedChartId = newChart.id;
            render();

            // let DOM paint then render chart canvas
            setTimeout(() => {
                try { renderChartOnCanvas(newChart); } catch (e) { console.warn('renderChartOnCanvas error', e); }
            }, 80);
        }

function applyDateFilter(range) {
    state.filters.dateRange = range;
    const data = state.data;
    if (!data || !state.filters.dateColumn || range === 'all') {
        state.filteredData = data;
        render();
        return;
    }
    
    const now = new Date();
    let cutoffDate = new Date();
    
    switch(range) {
        case 'week':
            cutoffDate.setDate(now.getDate() - 7);
            break;
        case 'month':
            cutoffDate.setMonth(now.getMonth() - 1);
            break;
        case 'quarter':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
        case 'year':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
    }
    
    state.filteredData = data.filter(row => {
        const date = parseDate(row[state.filters.dateColumn]);
        return date && date >= cutoffDate;
    });
    
    // Re-render all charts with filtered data
    render();
    setTimeout(() => {
        state.charts.forEach(chart => renderChartOnCanvas(chart));
    }, 100);
}

function applySearchFilter(query) {
    state.filters.searchQuery = query;
    const data = state.data;
    
    if (!data || !query.trim()) {
        state.filteredData = data;
        render();
        return;
    }
    
    const lowerQuery = query.toLowerCase();
    state.filteredData = data.filter(row => {
        return Object.values(row).some(val => 
            String(val).toLowerCase().includes(lowerQuery)
        );
    });
    
    render();
    setTimeout(() => {
        state.charts.forEach(chart => renderChartOnCanvas(chart));
    }, 100);
}


        // Command Palette
        function toggleCommandPalette() {
            state.showCommandPalette = !state.showCommandPalette;
            render();
        }

        const commands = [
            { id: 'new-workspace', title: 'New Workspace', subtitle: 'Create a new data workspace', icon: 'plus', action: () => console.log('New workspace') },
            { id: 'import-data', title: 'Import Data', subtitle: 'Upload CSV or Excel file', icon: 'upload', shortcut: 'Ctrl+O', action: () => document.getElementById('fileInput')?.click() },
            { id: 'export-pdf', title: 'Export PDF', subtitle: 'Generate PDF report', icon: 'download', shortcut: 'Ctrl+E', action: () => state.modal = 'export-pdf' },
            { id: 'toggle-theme', title: 'Toggle Theme', subtitle: 'Switch between light and dark', icon: 'moon', shortcut: 'Ctrl+/', action: toggleTheme },
            { id: 'presentation', title: 'Presentation Mode', subtitle: 'Enter full-screen mode', icon: 'maximize', shortcut: 'F', action: () => state.presentationMode = true }
        ];

        // Theme Toggle
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.body.className = state.theme === 'light' ? 'light' : '';
            render();
        }

        // Tutorial
        const tutorialSteps = [
            { title: 'Welcome to LimeNit DataWire', description: 'Let\'s take a quick tour to get you started', element: null },
            { title: 'Upload Your Data', description: 'Click "import Data" to upload CSV or Excel files', element: '.toolbar-btn.primary' },
            { title: 'Chart Library', description: 'Drag charts from the panel to your canvas', element: '.sidebar-section' },
            { title: 'Customize Charts', description: 'Click any chart to edit its properties', element: '.chart-container' },
            { title: 'Command Palette', description: 'Press Ctrl+K for quick actions', element: null }
        ];

        function nextTutorialStep() {
            state.tutorialStep++;
            if (state.tutorialStep >= tutorialSteps.length) {
                state.showTutorial = false;
                localStorage.setItem('tutorialCompleted', 'true');
            }
            render();
        }

        function skipTutorial() {
            state.showTutorial = false;
            localStorage.setItem('tutorialCompleted', 'true');
            render();
        }

        // Sample Data
        function loadSample() {
            showLoading('Loading sample data...');
            setTimeout(() => {
                state.data = [
                    { Date: '15/01/2024', Month: 'January', Sales: 45000, Expenses: 32000, Profit: 13000, Region: 'North' },
                    { Date: '15/02/2024', Month: 'February', Sales: 52000, Expenses: 35000, Profit: 17000, Region: 'South' },
                    { Date: '15/03/2024', Month: 'March', Sales: 48000, Expenses: 33000, Profit: 15000, Region: 'East' },
                    { Date: '15/04/2024', Month: 'April', Sales: 61000, Expenses: 38000, Profit: 23000, Region: 'West' },
                    { Date: '15/05/2024', Month: 'May', Sales: 55000, Expenses: 36000, Profit: 19000, Region: 'North' },
                    { Date: '15/06/2024', Month: 'June', Sales: 67000, Expenses: 40000, Profit: 27000, Region: 'South' }
                ];
                state.filteredData = state.data;
                state.filters.dateColumn = 'Date';
                state.currentPage = 'workspace';
                
                initializeChartLibrary();
                hideLoading();
                render();
            }, 800);
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                toggleCommandPalette();
            }
            if (e.key === 'Escape') {
                if (state.showCommandPalette) {
                    state.showCommandPalette = false;
                    render();
                }
                if (state.modal) {
                    state.modal = null;
                    render();
                }
            }
            if (e.key === 'F' && !e.ctrlKey && !e.metaKey && state.currentPage === 'workspace') {
                state.presentationMode = !state.presentationMode;
                render();
            }
        });

        function renderDataTable() {
    const data = state.filteredData || state.data;
    if (!data || data.length === 0) {
        return `<div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
            </svg>
            <div class="empty-state-title">No data available</div>
            <div class="empty-state-description">Upload a file to get started</div>
        </div>`;
    }
    
    const columns = Object.keys(data[0]);
    const displayData = data.slice(0, 100); // Show first 100 rows
    
    return `
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                Showing ${displayData.length} of ${data.length} rows
            </div>
            <button class="btn btn-secondary" onclick="exportToCSV()">
                <svg width="16" height="16" viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
            </button>
        </div>
        <div style="overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 300px); border: 1px solid var(--border-primary); border-radius: var(--radius-lg);">
            <table class="data-table">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                        ${columns.map(col => `
                            <th onclick="sortDataBy('${col}')">
                                ${col}
                                ${state.sortColumn === col ? (state.sortDirection === 'asc' ? ' ' : ' ') : ''}
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${displayData.map(row => `
                        <tr>
                            ${columns.map(col => `
                                <td>${row[col] !== null && row[col] !== undefined ? row[col] : ''}</td>
                            `).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderChartsView() {
    const hasCharts = state.charts.length > 0;
    
    return `
        <div class="chart-grid ${!hasCharts ? 'drop-zone' : ''}" id="dropZone" style="${!hasCharts ? 'min-height: 400px; display: flex; align-items: center; justify-content: center;' : ''}">
            ${!hasCharts ? `
                <div style="text-align: center;">
                    <svg class="empty-state-icon" viewBox="0 0 24 24">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Drag charts here to get started</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Choose from the chart library on the left</p>
                    <button class="btn btn-primary" onclick="if(state.chartLibrary[0]) addChartToCanvas(state.chartLibrary[0])">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add First Chart
                    </button>
                </div>
            ` : state.charts.map(chart => `
                <div class="chart-container ${state.selectedChartId === chart.id ? 'selected' : ''}" onclick="selectChart(${chart.id})">
                    <div class="chart-header">
                        <input type="text" class="chart-title-input" value="${chart.title}" placeholder="Chart title" 
                               onchange="updateChartProperty(${chart.id}, 'title', this.value)" 
                               onclick="event.stopPropagation()">
                        <div class="chart-actions">
                            <button class="icon-btn" title="Duplicate" 
                                    onclick="event.stopPropagation(); duplicateChart(${chart.id})">
                                <svg width="16" height="16" viewBox="0 0 24 24">
                                    <rect x="9" y="9" width="13" height="13" rx="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                            <button class="icon-btn" title="Remove" 
                                    onclick="event.stopPropagation(); removeChart(${chart.id})">
                                <svg width="16" height="16" viewBox="0 0 24 24">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <canvas id="chart-canvas-${chart.id}" style="max-height: 300px;"></canvas>
                </div>
            `).join('')}
        </div>
    `;
}

function sortDataBy(column) {
    const data = state.filteredData || state.data;
    if (!data) return;
    
    if (state.sortColumn === column) {
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        state.sortColumn = column;
        state.sortDirection = 'asc';
    }
    
    state.filteredData = [...data].sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // Try to parse as numbers
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return state.sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        // String comparison
        aVal = String(aVal || '');
        bVal = String(bVal || '');
        
        if (state.sortDirection === 'asc') {
            return aVal.localeCompare(bVal);
        } else {
            return bVal.localeCompare(aVal);
        }
    });
    
    render();
}

function exportToCSV() {
    const data = state.filteredData || state.data;
    if (!data || data.length === 0) return;
    
    const columns = Object.keys(data[0]);
    const csv = [
        columns.join(','),
        ...data.map(row => columns.map(col => {
            const val = row[col];
            return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
        }).join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'data-export.csv';
    a.click();
    URL.revokeObjectURL(url);
}

let selectedPDFTemplate = 'modern';

function selectPDFTemplate(id, event) {
    selectedPDFTemplate = id;
    
    // Update UI to show selection
    setTimeout(() => {
        document.querySelectorAll('.modal .template-card').forEach(card => {
            card.classList.remove('selected');
            const cardId = card.getAttribute('onclick');
            if (cardId && cardId.includes(`'${id}'`)) {
                card.classList.add('selected');
            }
        });
    }, 10);
}


async function generatePDF() {
    const reportName = document.querySelector('.modal-body input').value || 'Data Report';
    showLoading('Preparing PDF export...');
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        let yPosition = margin;
        let pageNumber = 1;
        
        // Color schemes for templates
        const templates = {
            modern: {
                primary: [255, 107, 107],
                secondary: [78, 205, 196],
                accent: [26, 26, 26],
                background: [248, 249, 250]
            },
            corporate: {
                primary: [26, 26, 26],
                secondary: [66, 66, 66],
                accent: [255, 107, 107],
                background: [255, 255, 255]
            },
            minimal: {
                primary: [0, 0, 0],
                secondary: [150, 150, 150],
                accent: [100, 100, 100],
                background: [255, 255, 255]
            },
            colorful: {
                primary: [102, 126, 234],
                secondary: [118, 75, 162],
                accent: [253, 203, 110],
                background: [255, 255, 255]
            }
        };
        
        const template = templates[selectedPDFTemplate] || templates.modern;
        
        // Helper function to add footer
        const addFooter = () => {
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(
                `Page ${pageNumber}  Generated by LimeNit`,
                pageWidth / 2,
                pageHeight - 10,
                { align: 'center' }
            );
            doc.setTextColor(0, 0, 0);
        };
        
        // Helper function to add new page
        const checkNewPage = (requiredSpace) => {
            if (yPosition + requiredSpace > pageHeight - 25) {
                addFooter();
                doc.addPage();
                pageNumber++;
                yPosition = margin;
                return true;
            }
            return false;
        };
        
        // ===== COVER PAGE =====
        if (selectedPDFTemplate === 'modern') {
            // Modern template - gradient header effect
            doc.setFillColor(...template.primary);
            doc.rect(0, 0, pageWidth, 60, 'F');
            
            // Accent line
            doc.setFillColor(...template.secondary);
            doc.rect(0, 60, pageWidth, 3, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(32);
            doc.setFont(undefined, 'bold');
            doc.text(reportName, pageWidth / 2, 35, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Analytics Report', pageWidth / 2, 48, { align: 'center' });
            
            yPosition = 80;
            
        } else if (selectedPDFTemplate === 'corporate') {
            // Corporate template - solid dark header
            doc.setFillColor(...template.primary);
            doc.rect(0, 0, pageWidth, 70, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text(reportName.toUpperCase(), margin, 35);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text('BUSINESS INTELLIGENCE REPORT', margin, 50);
            
            // Accent corner
            doc.setFillColor(...template.accent);
            doc.triangle(pageWidth - 30, 0, pageWidth, 0, pageWidth, 30, 'F');
            
            yPosition = 85;
            
        } else if (selectedPDFTemplate === 'colorful') {
            // Colorful template - gradient blocks
            doc.setFillColor(...template.primary);
            doc.rect(0, 0, pageWidth / 2, 65, 'F');
            
            doc.setFillColor(...template.secondary);
            doc.rect(pageWidth / 2, 0, pageWidth / 2, 65, 'F');
            
            doc.setFillColor(...template.accent);
            doc.rect(0, 65, pageWidth, 5, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(30);
            doc.setFont(undefined, 'bold');
            doc.text(reportName, pageWidth / 2, 35, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text('Creative Analytics Report', pageWidth / 2, 50, { align: 'center' });
            
            yPosition = 85;
            
        } else {
            // Minimal template - clean and simple
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...template.primary);
            doc.text(reportName, pageWidth / 2, 40, { align: 'center' });
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(...template.secondary);
            doc.line(margin, 50, pageWidth - margin, 50);
            
            yPosition = 65;
        }
        
        // Reset text color
        doc.setTextColor(0, 0, 0);
        
        // ===== METADATA SECTION =====
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        
        const metadata = [
            `Generated: ${new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`,
            `Time: ${new Date().toLocaleTimeString()}`,
        ];
        
        const data = state.filteredData || state.data;
        if (data) {
            metadata.push(`Total Records: ${data.length.toLocaleString()}`);
            metadata.push(`Charts Included: ${state.charts.length}`);
            metadata.push(`Columns: ${Object.keys(data[0]).length}`);
        }
        
        metadata.forEach((line, idx) => {
            doc.text(line, margin, yPosition + (idx * 6));
        });
        
        yPosition += (metadata.length * 6) + 15;
        doc.setTextColor(0, 0, 0);
        
        // ===== EXECUTIVE SUMMARY BOX =====
        if (data && state.charts.length > 0) {
            checkNewPage(40);
            
            // Summary box
            doc.setFillColor(248, 249, 250);
            doc.setDrawColor(...template.primary);
            doc.setLineWidth(0.5);
            doc.roundedRect(margin, yPosition, pageWidth - (margin * 2), 35, 3, 3, 'FD');
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...template.primary);
            doc.text('Executive Summary', margin + 5, yPosition + 8);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(60, 60, 60);
            
            const summary = [
                `This report contains ${state.charts.length} visualizations based on ${data.length} data records.`,
                `Analysis includes ${Object.keys(data[0]).length} data dimensions across multiple chart types.`,
                `Report generated using LimeNit.`
            ];
            
            summary.forEach((line, idx) => {
                doc.text(line, margin + 5, yPosition + 18 + (idx * 5), {
                    maxWidth: pageWidth - (margin * 2) - 10
                });
            });
            
            yPosition += 45;
            doc.setTextColor(0, 0, 0);
        }
        
        // ===== CHARTS SECTION =====
        showLoading('Rendering charts...');
        
        for (let i = 0; i < state.charts.length; i++) {
            const chart = state.charts[i];
            
            checkNewPage(120);
            
            // Section header
            doc.setFillColor(...template.primary);
            doc.rect(margin - 5, yPosition - 2, 3, 10, 'F');
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...template.primary);
            doc.text(chart.title || `Chart ${i + 1}`, margin + 3, yPosition + 5);
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(120, 120, 120);
            doc.text(`${chart.type.toUpperCase()} CHART`, pageWidth - margin, yPosition + 5, { align: 'right' });
            
            yPosition += 12;
            doc.setTextColor(0, 0, 0);
            
            // Get chart canvas
            const canvas = document.getElementById(`chart-canvas-${chart.id}`);
            if (canvas) {
                try {
                    // Convert canvas to high-quality image
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    
                    // Calculate dimensions
                    const maxWidth = pageWidth - (margin * 2);
                    const maxHeight = 100;
                    const aspectRatio = canvas.width / canvas.height;
                    
                    let imgWidth = maxWidth;
                    let imgHeight = imgWidth / aspectRatio;
                    
                    if (imgHeight > maxHeight) {
                        imgHeight = maxHeight;
                        imgWidth = imgHeight * aspectRatio;
                    }
                    
                    // Center the image
                    const xOffset = (pageWidth - imgWidth) / 2;
                    
                    // Add subtle border
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.3);
                    doc.rect(xOffset - 1, yPosition - 1, imgWidth + 2, imgHeight + 2, 'S');
                    
                    // Add image
                    doc.addImage(imgData, 'PNG', xOffset, yPosition, imgWidth, imgHeight, undefined, 'FAST');
                    yPosition += imgHeight + 15;
                    
                } catch (error) {
                    console.error('Error adding chart:', error);
                    doc.setFontSize(9);
                    doc.setTextColor(200, 50, 50);
                    doc.text(' Chart rendering error', margin, yPosition);
                    yPosition += 10;
                }
            }
            
            doc.setTextColor(0, 0, 0);
        }
        
        // ===== DATA TABLE SECTION =====
        if (data && data.length > 0) {
            showLoading('Adding data table...');
            
            checkNewPage(60);
            
            // Section header
            doc.setFillColor(...template.primary);
            doc.rect(margin - 5, yPosition - 2, 3, 10, 'F');
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...template.primary);
            doc.text('Data Summary', margin + 3, yPosition + 5);
            yPosition += 15;
            doc.setTextColor(0, 0, 0);
            
            const columns = Object.keys(data[0]);
            const displayColumns = columns.slice(0, 4); // Show 4 columns max
            const displayRows = data.slice(0, 15); // Show 15 rows max
            
            const tableWidth = pageWidth - (margin * 2);
            const colWidth = tableWidth / displayColumns.length;
            const rowHeight = 8;
            
            // Table header
            doc.setFillColor(...template.primary);
            doc.rect(margin, yPosition, tableWidth, rowHeight, 'F');
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 255, 255);
            
            displayColumns.forEach((col, idx) => {
                doc.text(
                    col.length > 15 ? col.substring(0, 13) + '..' : col,
                    margin + (idx * colWidth) + 2,
                    yPosition + 5.5
                );
            });
            
            yPosition += rowHeight;
            
            // Table rows
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            
            displayRows.forEach((row, rowIdx) => {
                if (checkNewPage(rowHeight + 5)) {
                    // Redraw header on new page
                    doc.setFillColor(...template.primary);
                    doc.rect(margin, yPosition, tableWidth, rowHeight, 'F');
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    displayColumns.forEach((col, idx) => {
                        doc.text(
                            col.length > 15 ? col.substring(0, 13) + '..' : col,
                            margin + (idx * colWidth) + 2,
                            yPosition + 5.5
                        );
                    });
                    yPosition += rowHeight;
                    doc.setFont(undefined, 'normal');
                }
                
                // Alternating row colors
                if (rowIdx % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin, yPosition, tableWidth, rowHeight, 'F');
                }
                
                doc.setTextColor(40, 40, 40);
                
                displayColumns.forEach((col, idx) => {
                    let value = String(row[col] || '');
                    if (value.length > 20) value = value.substring(0, 18) + '..';
                    
                    doc.text(
                        value,
                        margin + (idx * colWidth) + 2,
                        yPosition + 5.5
                    );
                });
                
                yPosition += rowHeight;
            });
            
            // Table footer note
            if (data.length > 15 || columns.length > 4) {
                yPosition += 5;
                doc.setFontSize(7);
                doc.setTextColor(120, 120, 120);
                const note = [];
                if (data.length > 15) note.push(`Showing 15 of ${data.length} rows`);
                if (columns.length > 4) note.push(`Showing 4 of ${columns.length} columns`);
                doc.text(note.join('  '), margin, yPosition);
            }
        }
        
        // Add footer to last page
        addFooter();
        
        // Save the PDF
        showLoading('Saving PDF...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        doc.save(`${reportName.replace(/\s+/g, '-').toLowerCase()}.pdf`);
        
        hideLoading();
        state.modal = null;
        render();
        
    } catch(error) {
        console.error('PDF generation error:', error);
        hideLoading();
        alert(' Error generating PDF:\n' + error.message);
    }
}
        // Render Functions
        function render() {
            const app = document.getElementById('app');
            
            if (state.currentPage === 'landing') {
                app.innerHTML = renderLanding();
                setupLandingEventListeners();
            } else if (state.currentPage === 'workspace') {
                app.innerHTML = renderWorkspace();
                setupWorkspaceEventListeners();
            } else if (state.currentPage === 'templates') {
                app.innerHTML = renderTemplates();
            }
            
            if (state.showCommandPalette) {
                app.innerHTML += renderCommandPalette();
            }
            
            if (state.showTutorial) {
                app.innerHTML += renderTutorial();
            }
            
            if (state.modal) {
                app.innerHTML += renderModal();
            }
            
            if (state.presentationMode) {
                app.innerHTML = renderPresentationMode();
            }
        }

        function renderLanding() {
            return `
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="logo"onclick="window.location.href='/';">
                            <span class="logo-accent">Lime</span>Nit
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="toggleTheme()">
                            <svg width="18" height="18">
                                ${state.theme === 'dark' ? 
                                    '<circle cx="9" cy="9" r="4"/><line x1="9" y1="1" x2="9" y2="3"/><line x1="9" y1="15" x2="9" y2="17"/><line x1="3.5" y1="3.5" x2="4.9" y2="4.9"/><line x1="13.1" y1="13.1" x2="14.5" y2="14.5"/><line x1="1" y1="9" x2="3" y2="9"/><line x1="15" y1="9" x2="17" y2="9"/><line x1="3.5" y1="14.5" x2="4.9" y2="13.1"/><line x1="13.1" y1="4.9" x2="14.5" y2="3.5"/>' :
                                    '<path d="M15 9A6 6 0 1 1 7.21 3 5 5 0 0 0 15 9z"/>'
                                }
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="min-height: calc(100vh - 56px); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div style="max-width: 900px; width: 100%;">
                        <div style="text-align: center; margin-bottom: 4rem;">
                            <h1 style="font-size: 4rem; font-weight: 700; margin-bottom: 1rem; letter-spacing: -2px;">
                                <span class="logo-accent">Data</span>Wire by LimeNit
                            </h1>
                            <p style="font-size: 1.25rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto;">
                                Transform your data into beautiful insights with modern analytics platform
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                            <div class="quick-action-card" onclick="document.getElementById('fileInput').click()">
                                <svg class="quick-action-icon" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">Import Data</h3>
                                <p style="font-size: 0.875rem; color: var(--text-secondary);">Upload CSV or Excel files</p>
                            </div>
                            
                            <div class="quick-action-card" onclick="loadSample()">
                                <svg class="quick-action-icon" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">Try Sample Data</h3>
                                <p style="font-size: 0.875rem; color: var(--text-secondary);">Explore with demo dataset</p>
                            </div>
                            
                            <div class="quick-action-card" onclick="state.currentPage='templates'; render();">
                                <svg class="quick-action-icon" viewBox="0 0 24 24">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">Browse Templates</h3>
                                <p style="font-size: 0.875rem; color: var(--text-secondary);">Export & presentation templates</p>
                            </div>
                        </div>
                        
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                        
                        <div style="text-align: center; padding-top: 2rem; border-top: 1px solid var(--border-primary);">
                            <p style="font-size: 0.875rem; color: var(--text-tertiary);">
                                Press <kbd style="padding: 0.25rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 4px; font-family: monospace;">Ctrl+K</kbd> for quick actions
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWorkspace() {
            const data = state.filteredData || state.data;
            const columns = data ? Object.keys(data[0]) : [];
            const dateColumns = columns.filter(col => isDateColumn(col));
            
            return `
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="logo" onclick="window.location.href='/';">
                            <span class="logo-accent">Lime</span>Nit
                        </div>
                        <div class="workspace-tabs">
                            ${state.workspaces.map(ws => `
                                <div class="workspace-tab ${ws.active ? 'active' : ''}">
                                    <span>${ws.name}</span>
                                    <svg class="close" width="14" height="14" viewBox="0 0 24 24">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </div>
                            `).join('')}
                            <button class="workspace-tab" title="New workspace" onclick="document.getElementById('fileInput').click()">
                                <svg width="14" height="14" viewBox="0 0 24 24">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="toggleCommandPalette()" title="Command Palette (Ctrl+K)">
                            <svg width="16" height="16" viewBox="0 0 24 24">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            <span>Search</span>
                        </button>
                        <button class="toolbar-btn primary" onclick="state.modal='export-pdf'; render();">
                            <svg width="16" height="16" viewBox="0 0 24 24">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span>Export</span>
                        </button>
                        <button class="toolbar-btn" onclick="toggleTheme()" title="Toggle theme">
                            <svg width="16" height="16" viewBox="0 0 24 24">
                                ${state.theme === 'dark' ? 
                                    '<circle cx="12" cy="12" r="4"/>' :
                                    '<path d="M17 12.79A7 7 0 1 1 9.21 3 5.5 5.5 0 0 0 17 12.79z"/>'
                                }
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="app-container">
                    <div class="sidebar" style="width: ${state.leftSidebarWidth}px;">
                        <div class="resize-handle resize-handle-right" id="leftResize"></div>
                        
                        <div class="sidebar-nav">
                            <div class="nav-item active" onclick="state.currentView='workspace'; render();">
                                <svg class="nav-icon" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                <span>Workspace</span>
                            </div>
                            <div class="nav-item" onclick="state.currentPage='templates'; render();">
                                <svg class="nav-icon" viewBox="0 0 24 24">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                <span>Templates</span>
                            </div>
                        </div>
                        
                        <div class="sidebar-content">
                            <div class="sidebar-section">
                                <div class="section-header" onclick="toggleSection('charts')">
                                    <span class="section-title">Chart Library</span>
                                    <svg class="section-toggle" width="14" height="14" viewBox="0 0 24 24">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                                <div class="section-content" id="section-charts" style="max-height: 500px;">
                                    ${state.chartLibrary.map(item => `
                                        <div class="chart-library-item" draggable="true" data-chart-id="${item.id}">
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" style="color: var(--primary);">
                                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                                </svg>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 500; font-size: 0.875rem;">${item.name}</div>
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${item.description}</div>
                                                </div>
                                            </div>
                                            <div class="chart-preview">
    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">Preview</div>
    <div style="height: 150px; background: var(--bg-secondary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
        <svg width="48" height="48" viewBox="0 0 24 24" style="color: var(--primary); opacity: 0.5;">
            ${item.type === 'bar' ? '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>' : ''}
            ${item.type === 'line' ? '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>' : ''}
            ${item.type === 'pie' || item.type === 'doughnut' ? '<circle cx="12" cy="12" r="10"/><path d="M12 2 L12 12 L20 16"/>' : ''}
            ${item.type === 'scatter' ? '<circle cx="8" cy="8" r="2"/><circle cx="16" cy="6" r="2"/><circle cx="12" cy="14" r="2"/><circle cx="18" cy="16" r="2"/>' : ''}
        </svg>
    </div>
    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem; text-align: center;">
        ${item.description}
    </div>
</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="sidebar-section">
                                <div class="section-header" onclick="toggleSection('data')">
                                    <span class="section-title">Data Columns</span>
                                    <svg class="section-toggle" width="14" height="14" viewBox="0 0 24 24">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                                <div class="section-content" id="section-data" style="max-height: 400px;">
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.75rem;">
                                        ${data ? data.length : 0} rows  ${columns.length} columns
                                    </div>
                                    ${columns.map(col => {
    const type = getColumnType(col);
    const isDate = isDateColumn(col);
    return `
        <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 0.5rem; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.875rem;">${col}</div>
                    <div style="margin-top: 0.25rem;">
                        <span class="badge badge-${type === 'number' ? 'success' : isDate ? 'secondary' : 'primary'}" style="font-size: 0.7rem;">
                            ${isDate ? 'date' : type}
                        </span>
                    </div>
                </div>
                ${isDate ? `
                    <button class="btn btn-ghost btn-icon" onclick="state.filters.dateColumn='${col}'; render();" title="Use as date filter" style="margin-left: 0.5rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </button>
                ` : ''}
            </div>
        </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">

    `;
}).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="main-canvas">
                        <div class="canvas-header">
                            <div class="canvas-title">Analytics Canvas</div>
                            <div class="canvas-actions">
                                <button class="btn btn-ghost btn-icon" onclick="state.dataViewMode = state.dataViewMode === 'charts' ? 'table' : 'charts'; render();" title="Toggle view">
    <svg width="18" height="18" viewBox="0 0 24 24">
        ${state.dataViewMode === 'charts' ? '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>' : '<line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><rect x="3" y="3" width="18" height="18" rx="2"/>'}
    </svg>
</button>
                                <button class="btn btn-ghost btn-icon" onclick="state.presentationMode=true; render();" title="Presentation mode (F)">
                                    <svg width="18" height="18" viewBox="0 0 24 24">
                                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                                    </svg>
                                </button>
                                <button class="btn btn-ghost btn-icon" onclick="state.rightPanelVisible=!state.rightPanelVisible; render();" title="Toggle panel">
                                    <svg width="18" height="18" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <line x1="15" y1="3" x2="15" y2="21"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        ${dateColumns.length > 0 || state.filters.searchQuery ? `
                            <div class="filter-bar">
                                ${dateColumns.length > 0 ? `
                                    <div class="filter-item">
                                        <label class="filter-label">Date Column</label>
                                        <select class="select" onchange="state.filters.dateColumn = this.value; render();">
                                            ${dateColumns.map(col => `
                                                <option value="${col}" ${state.filters.dateColumn === col ? 'selected' : ''}>${col}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="filter-item">
                                        <label class="filter-label">Time Range</label>
                                        <select class="select" onchange="applyDateFilter(this.value)">
                                            <option value="all">All Time</option>
                                            <option value="week">Last Week</option>
                                            <option value="month">Last Month</option>
                                            <option value="quarter">Last Quarter</option>
                                            <option value="year">Last Year</option>
                                        </select>
                                    </div>
                                ` : ''}
                                <div class="filter-item">
                                    <label class="filter-label">Search</label>
                                    <input type="text" class="input" placeholder="Search data..." value="${state.filters.searchQuery}" oninput="applySearchFilter(this.value)">
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="canvas-content">
    ${state.dataViewMode === 'table' ? renderDataTable() : renderChartsView()}
</div>
                    </div>
                    
                    <div class="right-panel ${state.rightPanelVisible ? '' : 'hidden'}" style="width: ${state.rightPanelWidth}px;">
                        <div class="resize-handle resize-handle-left" id="rightResize"></div>
                        
                        <div class="panel-header">
                            <span class="panel-title">Properties</span>
                            <button class="icon-btn" onclick="state.rightPanelVisible=false; render();">
                                <svg width="16" height="16" viewBox="0 0 24 24">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="panel-content">
                            ${state.selectedChartId ? renderChartProperties() : `
                                <div class="empty-state">
                                    <svg class="empty-state-icon" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m5.66-15.66l-4.24 4.24m-2.82 2.82l-4.24 4.24m15.56 0l-4.24-4.24m-2.82-2.82l-4.24-4.24"/>
                                    </svg>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                        Select a chart to edit its properties
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

                    function renderChartProperties() {
            const chart = state.charts.find(c => c.id === state.selectedChartId);
            if (!chart) return '';
            
            const data = state.filteredData || state.data;
            const columns = data ? Object.keys(data[0]) : [];
            const numericCols = columns.filter(col => getColumnType(col) === 'number');
            const categoricalCols = columns.filter(col => getColumnType(col) !== 'number');
            const dateColumns = columns.filter(col => isDateColumn(col));
            
            return `
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label">Chart Title</label>
                    <input type="text" class="input" value="${chart.title}" onchange="updateChartProperty(${chart.id}, 'title', this.value)">
                </div>
                
                ${chart.type === 'pie' || chart.type === 'doughnut' ? `
                    <div style="margin-bottom: 1.5rem;">
                        <label class="filter-label">Label Column</label>
                        <select class="select" onchange="updateChartConfig(${chart.id}, 'labelCol', this.value)">
                            ${categoricalCols.map(col => `
                                <option value="${col}" ${chart.config.labelCol === col ? 'selected' : ''}>${col}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="filter-label">Data Column</label>
                        <select class="select" onchange="updateChartConfig(${chart.id}, 'dataCol', this.value)">
                            ${numericCols.map(col => `
                                <option value="${col}" ${chart.config.dataCol === col ? 'selected' : ''}>${col}</option>
                            `).join('')}
                        </select>
                    </div>
                ` : `
                    <div style="margin-bottom: 1.5rem;">
                        <label class="filter-label">X-Axis Column ${dateColumns.length > 0 ? '(Date/Category)' : ''}</label>
                        <select class="select" onchange="updateChartConfig(${chart.id}, 'xCol', this.value)">
                            ${columns.map(col => `
                                <option value="${col}" ${chart.config.xCol === col ? 'selected' : ''}>${col}${isDateColumn(col) ? ' (Date)' : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="filter-label">Y-Axis Column (Numeric)</label>
                        <select class="select" onchange="updateChartConfig(${chart.id}, 'yCol', this.value)">
                            ${numericCols.map(col => `
                                <option value="${col}" ${chart.config.yCol === col ? 'selected' : ''}>${col}</option>
                            `).join('')}
                        </select>
                    </div>
                `}
                
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label">Chart Color</label>
                    <input type="color" value="${chart.color}" onchange="updateChartProperty(${chart.id}, 'color', this.value)" 
                           style="width: 100%; height: 40px; border: 1px solid var(--border-primary); border-radius: var(--radius-md); cursor: pointer;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" ${chart.showLegend ? 'checked' : ''} onchange="updateChartProperty(${chart.id}, 'showLegend', this.checked)">
                        <span style="font-size: 0.875rem; font-weight: 500;">Show Legend</span>
                    </label>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" ${chart.showLabels ? 'checked' : ''} onchange="updateChartProperty(${chart.id}, 'showLabels', this.checked)">
                        <span style="font-size: 0.875rem; font-weight: 500;">Show Labels</span>
                    </label>
                </div>
                
                <div style="padding-top: 1.5rem; border-top: 1px solid var(--border-primary);">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="duplicateChart(${chart.id})">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <rect x="9" y="9" width="13" height="13" rx="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        Duplicate Chart
                    </button>
                    <button class="btn" style="width: 100%;" onclick="removeChart(${chart.id})">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Remove Chart
                    </button>
                </div>
            `;
        }

        // Add this NEW function after updateChartProperty
function updateChartConfig(id, configKey, value) {
    const chart = state.charts.find(c => c.id === id || String(c.id) === String(id));
    if (!chart) return;
    
    // Update the config
    chart.config[configKey] = value;
    
    // Re-render the chart with new configuration
    render();
    
    setTimeout(() => {
        try {
            renderChartOnCanvas(chart);
        } catch(e) {
            console.warn('Chart render error:', e);
        }
    }, 100);
}

        function renderTemplates() {
            return `
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="logo" onclick="window.location.href='/';">
                            <span class="logo-accent">Lime</span>Nit
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="state.currentPage='workspace'; render();">
                            <svg width="16" height="16" viewBox="0 0 24 24">
                                <line x1="19" y1="12" x2="5" y2="12"/>
                                <polyline points="12 19 5 12 12 5"/>
                            </svg>
                            Back to Workspace
                        </button>
                    </div>
                </div>
                
                <div class="app-container">
                    <div class="sidebar">
                        <div class="sidebar-nav">
                            <div class="nav-item" onclick="state.currentView='workspace'; state.currentPage='workspace'; render();">
                                <svg class="nav-icon" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                <span>Workspace</span>
                            </div>
                            <div class="nav-item active">
                                <svg class="nav-icon" viewBox="0 0 24 24">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                <span>Templates</span>
                            </div>
                        </div>
                        
                        <div class="sidebar-content">
                            <div class="sidebar-section">
                                <div class="section-header" onclick="toggleSection('pdf')">
                                    <span class="section-title">PDF Export</span>
                                    <svg class="section-toggle" width="14" height="14" viewBox="0 0 24 24">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                                <div class="section-content" id="section-pdf" style="max-height: 500px;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                        ${state.templates.pdf.length} templates available
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sidebar-section">
                                <div class="section-header" onclick="toggleSection('presentation')">
                                    <span class="section-title">Presentations</span>
                                    <svg class="section-toggle" width="14" height="14" viewBox="0 0 24 24">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                                <div class="section-content" id="section-presentation" style="max-height: 500px;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                        ${state.templates.presentation.length} templates available
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="main-canvas">
                        <div class="canvas-header">
                            <div class="canvas-title">Export Templates</div>
                        </div>

                        <div class="canvas-content">
                            <div style="margin-bottom: 3rem;">
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">PDF Export Templates</h2>
                                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Professional templates for PDF reports</p>
                                
                                <div class="template-grid">
                                    ${state.templates.pdf.map(template => `
                                        <div class="template-card" onclick="selectTemplate('pdf', '${template.id}')">
                                            <div class="template-preview">
                                                ${template.preview}
                                            </div>
                                            <div class="template-info">
                                                <div class="template-name">${template.name}</div>
                                                <div class="template-description">${template.description}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">Presentation Templates</h2>
                                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Interactive full-screen presentations</p>
                                
                                <div class="template-grid">
                                    ${state.templates.presentation.map(template => `
                                        <div class="template-card" onclick="selectTemplate('presentation', '${template.id}')">
                                            <div class="template-preview">
                                                ${template.preview}
                                            </div>
                                            <div class="template-info">
                                                <div class="template-name">${template.name}</div>
                                                <div class="template-description">${template.description}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
            `;
        }

        function renderCommandPalette() {
            return `
                <div class="command-palette-overlay" onclick="if(event.target===this) toggleCommandPalette()">
                    <div class="command-palette">
                        <input type="text" class="command-input" placeholder="Type a command or search..." autofocus>
                        <div class="command-results">
                            ${commands.map(cmd => `
                                <div class="command-item" onclick="${cmd.action.toString().replace('function', '').replace('()', '')}(); toggleCommandPalette();">
                                    <svg class="command-item-icon" viewBox="0 0 24 24">
                                        ${cmd.icon === 'plus' ? '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' : ''}
                                        ${cmd.icon === 'upload' ? '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>' : ''}
                                        ${cmd.icon === 'download' ? '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>' : ''}
                                        ${cmd.icon === 'moon' ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>' : ''}
                                        ${cmd.icon === 'maximize' ? '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>' : ''}
                                    </svg>
                                    <div class="command-item-text">
                                        <div class="command-item-title">${cmd.title}</div>
                                        <div class="command-item-subtitle">${cmd.subtitle}</div>
                                    </div>
                                    ${cmd.shortcut ? `<div class="command-item-shortcut">${cmd.shortcut}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTutorial() {
            const step = tutorialSteps[state.tutorialStep];
            return `
                <div class="tutorial-overlay">
                    <div class="tutorial-card">
                        <div class="tutorial-progress">
                            ${tutorialSteps.map((_, i) => `
                                <div class="tutorial-dot ${i === state.tutorialStep ? 'active' : ''}"></div>
                            `).join('')}
                        </div>
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem;">${step.title}</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem;">${step.description}</p>
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                            <button class="btn btn-ghost" onclick="skipTutorial()">Skip</button>
                            <button class="btn btn-primary" onclick="nextTutorialStep()">
                                ${state.tutorialStep === tutorialSteps.length - 1 ? 'Get Started' : 'Next'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModal() {
            if (state.modal === 'export-pdf') {
                return `
                    <div class="modal-overlay" onclick="if(event.target===this) state.modal=null; render();">
                        <div class="modal" style="width: 800px;">
                            <div class="modal-header">
                                <div class="modal-title">Export to PDF</div>
                                <button class="icon-btn" onclick="state.modal=null; render();">
                                    <svg width="18" height="18" viewBox="0 0 24 24">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 2rem;">
                                    <label class="filter-label">Report Name</label>
                                    <input type="text" class="input" placeholder="Enter report name" value="Data Report">
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <label class="filter-label">Select Template</label>
                                    <div class="template-grid">
    ${state.templates.pdf.map((template, idx) => `
        <div class="template-card ${idx === 0 ? 'selected' : ''}" onclick="selectPDFTemplate('${template.id}', event)">
            <div class="template-preview">
                ${template.preview}
            </div>
            <div class="template-info">
                <div class="template-name">${template.name}</div>
                <div class="template-description">${template.description}</div>
            </div>
        </div>
    `).join('')}
</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-ghost" onclick="state.modal=null; render();">Cancel</button>
                                <button class="btn btn-primary" onclick="generatePDF()">
                                    <svg width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                    Generate PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function renderPresentationMode() {
            return `
                <div class="presentation-mode">
                    <div class="presentation-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="logo">
                                <span class="logo-accent">Lime</span>Nit
                            </div>
                            <span style="color: var(--text-secondary); font-size: 0.875rem;">Presentation Mode</span>
                        </div>
                        <div class="presentation-nav">
                            <button class="btn btn-ghost btn-icon" title="Previous ()">
                                <svg width="18" height="18" viewBox="0 0 24 24">
                                    <line x1="19" y1="12" x2="5" y2="12"/>
                                    <polyline points="12 19 5 12 12 5"/>
                                </svg>
                            </button>
                            <span style="color: var(--text-secondary); font-size: 0.875rem;">1 / ${state.charts.length}</span>
                            <button class="btn btn-ghost btn-icon" title="Next ()">
                                <svg width="18" height="18" viewBox="0 0 24 24">
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                    <polyline points="12 5 19 12 12 19"/>
                                </svg>
                            </button>
                            <button class="btn btn-ghost" onclick="state.presentationMode=false; render();" title="Exit (Esc)">
                                <svg width="16" height="16" viewBox="0 0 24 24">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                                Exit
                            </button>
                        </div>
                    </div>
                    <div class="presentation-content">
                        <div class="presentation-slide">
                            <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 2rem;">
                                ${state.charts[0]?.title || 'Data Analysis'}
                            </h1>
                            ${state.charts[0] ? `
                                <div style="height: 500px; display: flex; align-items: center; justify-content: center;">
                                    <canvas id="presentation-chart" style="max-height: 100%;"></canvas>
                                </div>
                            ` : `
                                <div class="empty-state">
                                    <p style="color: var(--text-secondary);">No charts to present</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper Functions
        function toggleSection(id) {
            const section = document.getElementById(`section-${id}`);
            const header = section?.previousElementSibling;
            if (section && header) {
                section.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
            }
        }

function removeChart(id) {
    const chartIndex = state.charts.findIndex(c => c.id === id || String(c.id) === String(id));
    if (chartIndex === -1) return;
    
    // Destroy the chart canvas first
    try {
        const canvas = document.getElementById(`chart-canvas-${id}`);
        if (canvas) {
            const chartInstance = Chart.getChart(canvas);
            if (chartInstance) {
                chartInstance.destroy();
            }
        }
    } catch(e) {
        console.warn('Chart destruction error:', e);
    }
    
    // Remove from state
    state.charts.splice(chartIndex, 1);
    
    // Update selection
    if (state.selectedChartId === id || String(state.selectedChartId) === String(id)) {
        state.selectedChartId = state.charts.length > 0 ? state.charts[0].id : null;
    }
    
    render();
}

function duplicateChart(id) {
    const originalChart = state.charts.find(c => c.id === id || String(c.id) === String(id));
    if (!originalChart) return;
    
    // Deep clone to avoid reference issues
    const newChart = {
        id: Date.now() + Math.floor(Math.random() * 1000),
        type: originalChart.type,
        name: originalChart.name,
        description: originalChart.description,
        title: `${originalChart.title} (Copy)`,
        color: originalChart.color,
        showLegend: originalChart.showLegend,
        showLabels: originalChart.showLabels,
        config: { ...originalChart.config }
    };
    
    // Insert after the original
    const originalIndex = state.charts.findIndex(c => c.id === id || String(c.id) === String(id));
    if (originalIndex !== -1) {
        state.charts.splice(originalIndex + 1, 0, newChart);
    } else {
        state.charts.push(newChart);
    }
    
    state.selectedChartId = newChart.id;
    render();
    
    setTimeout(() => {
        try {
            renderChartOnCanvas(newChart);
        } catch(e) {
            console.warn('Chart render error:', e);
        }
    }, 100);
}

// ------------ updateChartProperty ------------
function updateChartProperty(id, key, value) {
    const chart = state.charts.find(c => c.id === id || String(c.id) === String(id));
    if (!chart) return;
    
    // Type conversion for form inputs
    if (key === 'showLegend' || key === 'showLabels') {
        value = value === true || value === 'true' || value === 'on';
    } else if (key === 'color' && typeof value === 'string') {
        // Keep color as string
    } else if (key === 'title' && typeof value === 'string') {
        // Keep title as string
    }
    
    chart[key] = value;
    
    // Re-render the chart for all visual properties
    if (['color', 'showLegend', 'showLabels'].includes(key)) {
        setTimeout(() => {
            try {
                renderChartOnCanvas(chart);
            } catch(e) {
                console.warn('Chart render error:', e);
            }
        }, 50);
    } else if (key === 'title') {
        // For title changes, re-render the page to update the title input
        render();
    }
}


        function selectTemplate(type, id) {
            console.log(`Selected ${type} template: ${id}`);
            alert(`Template "${id}" selected! This would open the export dialog.`);
        }
//
        /*function generatePDF() {
            showLoading('Generating PDF...');
            setTimeout(() => {
                hideLoading();
                state.modal = null;
                render();
                alert('PDF generated successfully!');
            }, 1500);
        }
        */
        // Event Listeners Setup
        function setupLandingEventListeners() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.onchange = (e) => {
                    if (e.target.files[0]) {
                        handleFileUpload(e.target.files[0]);
                    }
                };
            }
        }

        function setupWorkspaceEventListeners() {
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.onchange = (e) => {
            if (e.target.files[0]) {
                handleFileUpload(e.target.files[0]);
            }
        };
    }
    
    // Drag and drop for charts
    const chartItems = document.querySelectorAll('.chart-library-item');
    chartItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            const chartId = e.currentTarget.getAttribute('data-chart-id');
            e.dataTransfer.setData('chartId', chartId);
            e.currentTarget.classList.add('dragging');
        });
        
        item.addEventListener('dragend', (e) => {
            e.currentTarget.classList.remove('dragging');
        });
        
        // Add click handler for mobile/non-drag
        item.addEventListener('click', (e) => {
            const chartId = e.currentTarget.getAttribute('data-chart-id');
            const libraryItem = state.chartLibrary.find(item => item.id === chartId);
            if (libraryItem) {
                addChartToCanvas(libraryItem);
            }
        });
    });
    
    // Drop zone for entire canvas area

    // Drop zone for entire canvas area
const dropZone = document.getElementById('dropZone');
if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!e.relatedTarget || !dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove('drag-over');
        }
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('drag-over');
        
        const chartId = e.dataTransfer.getData('chartId');
        const libraryItem = state.chartLibrary.find(item => item.id === chartId);
        if (libraryItem) {
            addChartToCanvas(libraryItem);
        }
    });
}
    
    // Resize handles
    setupResizeHandles();
    
    // Render existing charts
    setTimeout(() => {
        state.charts.forEach(chart => {
            renderChartOnCanvas(chart);
        });
    }, 100);
}

 // Render Chart on Canvas
        function renderChartOnCanvas(chart) {
            const data = state.filteredData || state.data;
            if (!data) return;
            
            const ctx = document.getElementById(`chart-canvas-${chart.id}`);
            if (!ctx) return;
            
            const { config } = chart;
            let chartData, chartConfig;
            
            if (chart.type === 'pie' || chart.type === 'doughnut') {
                const aggregated = {};
                data.forEach(row => {
                    const label = row[config.labelCol];
                    const value = parseFloat(row[config.dataCol]) || 0;
                    aggregated[label] = (aggregated[label] || 0) + value;
                });
                
                chartData = {
                    labels: Object.keys(aggregated),
                    datasets: [{
                        data: Object.values(aggregated),
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#a29bfe', '#fd79a8', '#fdcb6e', '#6c5ce7', '#00b894', '#e17055'],
                        borderWidth: 2,
                        borderColor: state.theme === 'dark' ? '#1a1a1a' : '#ffffff'
                    }]
                };
                
                chartConfig = {
                    type: chart.type,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: chart.showLegend,
                                position: 'bottom',
                                labels: {
                                    color: state.theme === 'dark' ? '#ffffff' : '#1a1a1a',
                                    padding: 15,
                                    font: { size: 12, family: 'Inter' }
                                }
                            }
                        }
                    }
                };
            } else {
                const limited = data.slice(0, 20);
                chartData = {
                    labels: limited.map(row => row[config.xCol]),
                    datasets: [{
                        label: config.yCol,
                        data: limited.map(row => parseFloat(row[config.yCol]) || 0),
                        backgroundColor: chart.type === 'scatter' ? chart.color : chart.color + 'CC',
                        borderColor: chart.color,
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: chart.type === 'scatter' ? 6 : 4
                    }]
                };
                
                chartConfig = {
                    type: chart.type === 'scatter' ? 'scatter' : chart.type,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: chart.showLegend }
                        },
                        scales: {
                            x: {
                                ticks: { 
                                    color: state.theme === 'dark' ? '#a0a0a0' : '#6c757d',
                                    maxRotation: 45
                                },
                                grid: { display: false }
                            },
                            y: {
                                ticks: { color: state.theme === 'dark' ? '#a0a0a0' : '#6c757d' },
                                grid: { display: false }
                            }
                        }
                    }
                };
            }
            
            // Destroy existing Chart.js instance
try {
    const existingChart = Chart.getChart(ctx);
    if (existingChart) {
        existingChart.destroy();
    }
} catch(e) { /* ignore */ }

// Create new chart
const newChart = new Chart(ctx, chartConfig);
        }

        function setupResizeHandles() {
            const leftResize = document.getElementById('leftResize');
            const rightResize = document.getElementById('rightResize');
            
            if (leftResize) {
                leftResize.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    const startX = e.clientX;
                    const startWidth = state.leftSidebarWidth;
                    
                    const onMouseMove = (e) => {
                        const delta = e.clientX - startX;
                        state.leftSidebarWidth = Math.max(200, Math.min(400, startWidth + delta));
                        document.querySelector('.sidebar').style.width = `${state.leftSidebarWidth}px`;
                    };
                    
                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }
            
            if (rightResize) {
                rightResize.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    const startX = e.clientX;
                    const startWidth = state.rightPanelWidth;
                    
                    const onMouseMove = (e) => {
                        const delta = startX - e.clientX;
                        state.rightPanelWidth = Math.max(280, Math.min(500, startWidth + delta));
                        document.querySelector('.right-panel').style.width = `${state.rightPanelWidth}px`;
                    };
                    
                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }
        }

        // Initialize
        render();
    </script>
</body>
</html>  
